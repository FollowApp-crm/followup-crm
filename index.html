<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Follow-Up CRM ‚Äî Standalone</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='12' fill='%237c5cff'/%3E%3Cpath d='M18 34l8 8 20-20' stroke='%23fff' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />
<style>
/* ===== Lead paste block ===== */
.lead-block{
  display:block;
  margin-bottom:12px;
}
.lead-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:6px; }

/* =================== TOKENS =================== */
:root{
  --bg:#0f1117; --panel:#151a21; --card:#1a2130; --chip:#1b2230; --surface:#10151d;
  --ink:#e8ecf3; --muted:#9aa3c7; --line:#262b36;
  --accent:#7c5cff; --accent-2:#28c076;
  --danger:#d94a4a; --danger-border:#9e3636; --danger-ring:rgba(217,74,74,.25);
  --page-max:1080px; --page-pad:16px; --radius:16px;
}
body.light{
  --bg:#f7f8fb; --panel:#ffffff; --card:#f2f4ff; --chip:#eef2fb; --surface:#ffffff;
  --ink:#0f1115; --muted:#55607a; --line:#e2e7f3;
  --accent:#7c5cff; --accent-2:#28c076;
  --danger:#d94a4a; --danger-border:#c64545; --danger-ring:rgba(217,74,74,.25);
}

/* =================== BASE =================== */
*{box-sizing:border-box}
html,body{height:100%; max-width:100%; overflow-x:hidden}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(1200px 800px at 100% -10%, rgba(124,92,255,.16), transparent),
    var(--bg);
  color:var(--ink);
}
a{ color:#8ea3ff; text-decoration:none }
a:hover{ text-decoration:underline }

.wrap{
  width:100%;
  max-width:var(--page-max);
  margin-left:auto; margin-right:auto;
  padding-left:max(var(--page-pad), env(safe-area-inset-left));
  padding-right:max(var(--page-pad), env(safe-area-inset-right));
  padding-top:16px; padding-bottom:16px;
}
.grid{display:grid; gap:16px; grid-template-columns:1fr; align-items:start}
.grid > *, .row > * { min-width:0; }

/* =================== HEADER =================== */
header{
  position:sticky; top:0; z-index:5;
  background:linear-gradient(180deg, rgba(15,17,23,.85), rgba(15,17,23,.65) 70%, rgba(15,17,23,0));
  border-bottom:1px solid var(--line);
  backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  padding-top:env(safe-area-inset-top);
}
/* Light mode: keep the glassy blur like dark mode */
body.light header{
  background: linear-gradient(
      180deg,
      rgba(255,255,255,.85),
      rgba(255,255,255,.65) 70%,
      rgba(255,255,255,0)
  );
  border-bottom: 1px solid var(--line);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: none; /* remove the flat divider shadow */
}


/* =================== CARDS / CONTROLS =================== */
.card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.25);} 
.card .hd{padding:12px 14px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px}
.card .bd{padding:14px}

label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
input,select,textarea,button{
  border-radius:10px; border:1px solid var(--line); background:var(--surface); color:var(--ink); padding:10px 12px; outline:none; height:44px
}
textarea{height:auto; min-height:96px; resize:vertical}
input:focus,select:focus,textarea:focus{ border-color:#445; box-shadow:0 0 0 3px rgba(124,92,255,.15) }

/* Light theme controls */
body.light input,
body.light select,
body.light textarea,
body.light button:not(.primary):not(.ghost):not(.btn-danger):not(.toggle) {
  background:#fff; color:var(--ink); border-color:var(--line);
}

/* Flash the Agenda date field when it‚Äôs changed from the calendar */
@keyframes agendaDateGlow{
  0%   { box-shadow: 0 0 0 0 rgba(124,92,255,.45), 0 0 0 6px rgba(124,92,255,.18); }
  100% { box-shadow: 0 0 0 0 rgba(124,92,255,0); }
}
#agendaDate.glow{
  animation: agendaDateGlow 900ms ease-out;
  border-color:#6a4ff0;
  background:linear-gradient(180deg, rgba(124,92,255,.12), rgba(124,92,255,.05)), var(--surface);
}
@media (prefers-reduced-motion: reduce){ #agendaDate.glow{ animation:none; } }

button{cursor:pointer; background:linear-gradient(180deg,#2c2f44,#1b2130); border:1px solid #2b3346; color:var(--ink)}
button.primary{ background:linear-gradient(180deg,var(--accent),#6a4ff0); border-color:#6a4ff0; color:#fff }
button.ghost{ background:transparent }

/* Icon buttons */
.btn-icon{width:32px; height:32px; display:inline-flex; align-items:center; justify-content:center; padding:0; border-radius:10px; background:var(--chip); border:1px solid var(--line)}
body.light .btn-icon{ background:#fff; border:1px solid var(--line) }

/* === Add Customer modal + fancy "+" === */
body.modal-open{ overflow:hidden; }
.add-btn{
  width:34px; height:34px; border-radius:999px;
  background:linear-gradient(180deg,var(--accent),#6a4ff0);
  color:#fff; border:1px solid #6a4ff0;
  box-shadow:0 8px 26px rgba(124,92,255,.35);
  font-weight:900; line-height:1; padding:0;
}
.add-btn:hover{ filter:brightness(1.06); transform:translateY(-1px); }
.add-btn:active{ transform:translateY(0); }
.modal{
  position:fixed; inset:0; display:none;
  align-items:center; justify-content:center;
  padding:18px; background:rgba(0,0,0,.5);
  backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px);
  z-index:9998;
  overflow:auto;                 /* can scroll if user expands "More fields" */
}
.modal.open{ display:flex; }
.modal .card{
  width:min(560px, 100%);
  max-height:90dvh;             /* keep it on-screen */
  overflow:auto;                 /* self-scroll only when needed */
  animation:pop .16s ease-out;
}
@keyframes pop{ from{ opacity:0; transform:translateY(10px) scale(.985) } to{ opacity:1; transform:none } }
/* Hide the Add/Edit section until JS moves it into the modal */
#addCard{ display:none; }

/* compact form when inside modal */
.modal .card .bd textarea#leadBlob{ min-height:72px }
.modal .card .bd input,
.modal .card .bd select,
.modal .card .bd textarea{ height:38px; padding:8px 10px }
.modal .card .bd textarea{ min-height:66px }

/* Toolbar, pills, etc. */
.toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
.space{flex:1}
.toggle{height:36px; padding:6px 12px; border-radius:999px; font-size:13px; border:1px solid #2b3346; background:linear-gradient(180deg,#2c2f44,#1b2130); color:var(--ink)}
body.light .toggle{ background:#fff; border-color:#d9e1f1 }

.badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:var(--chip); border:1px solid var(--line); border-radius:999px; font-size:12px; color:#b6bfd6}
.pill{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--line); background:var(--chip); color:#bfc7ff; white-space:nowrap; }
.copy-btn{ margin-left:6px; width:18px; height:18px; display:inline-flex; align-items:center; justify-content:center; border-radius:6px; border:1px solid var(--line); background:var(--panel); font-size:12px; line-height:1; cursor:pointer; padding:0; }
.copy-btn:active{ transform:translateY(1px); }
body.light .copy-btn{ background:#fff; }

.btn-danger{
  background: var(--danger) !important; border-color: var(--danger-border) !important;
  color:#fff !important; box-shadow:none !important;
}

/* Segmented control, slabs, helpers */
.seg{ display:inline-flex; gap:0; background: var(--chip); border:1px solid var(--line); border-radius:10px; padding:2px; overflow:hidden; }
.seg > button{ background: transparent !important; border:0; color: var(--ink); height:34px; padding:0 12px; border-radius:8px; }
.seg > button.primary{ background: var(--panel) !important; box-shadow: inset 0 0 0 1px var(--line); color: var(--ink) !important; }

.or-note{ margin: 6px 0 10px; text-align:center; font-size:12px; font-weight:700; letter-spacing:.06em; color: var(--muted); }
.or-note::before,.or-note::after{ content:""; display:inline-block; width:24px; height:1px; background: var(--line); margin: 0 8px; vertical-align: middle; }

.lead-block.highlight{
  padding:10px; border:1px dashed var(--accent); border-radius:12px;
  background: linear-gradient(180deg, rgba(124,92,255,.09), rgba(124,92,255,.04)), var(--surface);
}
.lead-block.highlight textarea{ border-width:2px; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,92,255,.12); }
.slab{ background:var(--surface); border:1px solid var(--line); border-radius:12px; padding:12px }
.flex-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }

/* =================== LAYOUT HELPERS =================== */
.row{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px}
.row.single{grid-template-columns:1fr}
.right{display:flex; gap:8px; justify-content:flex-end}

/* === Two-column Agenda + Calendar (desktop) === */
.row.agenda-layout{
  grid-template-columns: minmax(0, 2.2fr) minmax(360px, 1.2fr);
  gap:16px; align-items:start;
}

/* Compact calendar look (small right rail) */
#calendarCard .bd{ padding:12px; }
#calendarGrid{ gap:4px; }
.cal-cell{ min-height:56px; padding:6px; }
.cal-badge{ margin-top:4px; font-size:10.5px; }

/* Make ONLY the Agenda + Calendar row wider than the page wrap (desktop) */
@media (min-width:1001px){
  .row.agenda-layout{
    --agenda-bleed: clamp(80px, 6vw, 180px);
    width: calc(100% + var(--agenda-bleed) * 2);
    margin-left: calc(var(--agenda-bleed) * -1);
    margin-right: calc(var(--agenda-bleed) * -1);
  }
}

/* =================== KPI =================== */
.kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
.kpi .box{background:var(--card); border:1px solid #293149; border-radius:14px; padding:12px}
body.light .kpi .box{ background:var(--card); border-color:var(--line) }
.kpi .num{font-size:22px; font-weight:800}

/* =================== TABLE (+ mobile cards) =================== */
.tbl{width:100%; border-collapse:separate; border-spacing:0; table-layout:fixed}
.tbl th,.tbl td{padding:10px; border-bottom:1px solid var(--line); text-align:left; font-size:13px; vertical-align:middle; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
.tbl th{color:#a8b0c4; font-weight:600; position:sticky; top:0; background:var(--panel)}
.note-preview{color:#9aa3bb; cursor:pointer; font-family:ui-monospace,Menlo,Consolas,monospace}
.note-preview:hover{text-decoration:underline}
.actions{display:flex; gap:6px; justify-content:flex-end; align-items:center}

/* =================== AGENDA =================== */
.agenda-item{display:grid; grid-template-columns:24px 1fr auto; gap:10px; align-items:center; padding:8px 10px; border:1px solid var(--line); border-radius:12px; background:var(--surface)}
.agenda-item.done{opacity:.55}
.group-hd{ display:flex; align-items:center; gap:8px; margin:12px 0 6px }
.group-hd::before, .group-hd::after{ content:""; flex:1; height:1px; background:var(--line) }
.group-hd .label{ font-size:12px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; background:var(--chip); color:#bfc7ff }

.tiny{font-size:11px; color:var(--muted)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px}
.progress{height:12px; border-radius:999px; background:var(--chip); border:1px solid var(--line); overflow:hidden}
.progress > span{display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent-2)); width:0}

/* =================== CALENDAR =================== */
#calendarGrid{ display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:6px }
.cal-head{ font-weight:700; font-size:12px; opacity:.8; padding:4px 2px; text-align:center }
.cal-cell{ border:1px solid var(--line); border-radius:8px; padding:8px; min-height:74px; background:var(--surface); cursor:pointer }
.cal-cell .d{ font-weight:700; font-size:12px; opacity:.9 }
.cal-badge{ display:inline-block; margin-top:6px; font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:999px; color:#cfd5ff }
.cal-cell.offday{ background: linear-gradient(0deg, rgba(220,80,80,.08), rgba(220,80,80,.08)), var(--surface); border-color: #3a2b2f; }
.cal-cell.offday .d { color: #e2b3b3; }

.cal-hd{ display:flex; align-items:center; gap:10px }
.cal-hd .space{ flex:1 }
.cal-month{ display:flex; align-items:center; gap:8px }
#calTitle{ display:block; text-align:center; }

.settings-btn{
  height:32px; padding:6px 12px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; gap:6px; line-height:1;
}
#calSettings{ margin-top:10px; border:1px solid var(--line); border-radius:12px; padding:16px; background:var(--surface) }
.wdays{ display:grid; grid-template-columns:repeat(7,1fr); gap:16px; margin-top:8px }
.wdays .cell{ border:1px dashed var(--line); border-radius:10px; padding:12px; display:flex; align-items:center; gap:8px; justify-content:center }
.switch-row{ display:flex; align-items:center; gap:10px; margin-top:14px }
.ovr{ margin-top:14px; display:grid; grid-template-columns: 200px 1fr 120px auto; gap:10px; align-items:center }
.ovr-list{ margin-top:10px; padding-left:0; list-style:none }
.ovr-list li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:var(--surface) }

/* =================== MOBILE POLISH =================== */
@media (max-width:760px){
  .wrap{padding-top:12px;padding-bottom:12px}
  .row{grid-template-columns:1fr}
  .kpi{grid-template-columns:repeat(2,1fr)}
  .tbl thead{display:none}
  .tbl tr{display:block; background:var(--surface); border:1px solid var(--line); border-radius:12px; margin:10px 0}
  .tbl td{display:flex; gap:10px; justify-content:space-between; align-items:center; white-space:normal}
  .tbl td::before{content:attr(data-label); color:var(--muted); font-size:12px}
  .actions{justify-content:flex-start}
  header{ background:var(--panel); box-shadow:0 1px 0 var(--line); }
  .ovr{ grid-template-columns:1fr; }
}

/* =================== SCROLLBARS =================== */
html{ scrollbar-gutter: stable both-edges; }
:root{ color-scheme: dark light; }
:root{
  --sb-size: 12px; --sb-radius: 10px;
  --sb-thumb: #2f3547; --sb-thumb-hover: #3b4362; --sb-thumb-active:#4a568e;
  --sb-track: transparent;
}
body.light{
  --sb-thumb: #c1c9ee; --sb-thumb-hover: #aeb8ea; --sb-thumb-active:#97a4e6; --sb-track: #eef2ff;
}
*{ scrollbar-width: thin; scrollbar-color: var(--sb-thumb) var(--sb-track); }
*::-webkit-scrollbar{ width: var(--sb-size); height: var(--sb-size); }
*::-webkit-scrollbar-track{ background: var(--sb-track); }
*::-webkit-scrollbar-thumb{
  background: var(--sb-thumb); border-radius: var(--sb-radius);
  background-clip: padding-box; border: 3px solid transparent;
}
*::-webkit-scrollbar-thumb:hover{  background: var(--sb-thumb-hover); }
*::-webkit-scrollbar-thumb:active{ background: var(--sb-thumb-active); }
*::-webkit-scrollbar-corner{ background: transparent; }

/* Checkbox polish */
body { color-scheme: dark; }        /* default app theme */
body.light { color-scheme: light; }
.agenda-item input[type="checkbox"], input[type="checkbox"]{ width: 18px; height: 18px; padding: 0; accent-color: var(--accent); }

/* Spacing utilities used in markup */
.mt12{margin-top:12px}
.mt16{margin-top:16px}
</style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:12px">
      <div>
        <h1>Follow-Up CRM</h1>
        <div class="sub">Single-file CRM for <b>Unreached</b> and <b>Reached</b> customers, agenda & calendar.</div>
      </div>
      <div class="space"></div>
      <button id="themeToggle" class="toggle" aria-label="Toggle theme">‚òÄÔ∏è Light</button>
    </div>
  </header>

  <main class="wrap grid">

    <!-- Add/Edit card (moved into modal at runtime) -->
    <section class="card" id="addCard">
      <div class="hd">
        <strong>Add / Edit Customer</strong>
        <span class="badge">Local only</span>
        <div class="space"></div>
        <button id="closeAdd" class="btn-icon" title="Close">‚úñ</button>
      </div>
      <div class="bd">
        <div class="lead-block highlight">
          <div>
            <label>Paste from Leads CRM (auto-fills fields)</label>
            <textarea id="leadBlob" rows="5" placeholder="Paste the whole blob here‚Ä¶"></textarea>
          </div>
          <div class="lead-actions">
            <button type="button" id="clearLead" class="ghost">Clear</button>
          </div>
        </div>

        <!-- Quick fields (always visible, no scroll needed) -->
        <form id="clientForm" novalidate>
          <input type="hidden" id="clientId" />
          <div class="row">
            <div>
              <label>Name</label>
              <input id="name" required placeholder="John Appleseed" />
            </div>
            <div>
              <label>Email</label>
              <input id="email" type="email" placeholder="john@company.com" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Phone</label>
              <input id="phone" placeholder="+1 555 123 4567" />
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="unreached">Unreached</option>
                <option value="reached">Reached</option>
              </select>
            </div>
          </div>

          <!-- Collapsible "More fields" to keep popup small -->
          <div class="row single" style="margin-top:6px">
            <button type="button" id="advToggle" class="ghost" style="justify-self:start; height:32px">‚ñ∏ More fields</button>
          </div>

          <div id="advFields" style="display:none">
            <div class="row">
              <div>
                <label>Route</label>
                <input id="route" placeholder="JFK-LHR-AMS" />
              </div>
              <div>
                <label>Pax</label>
                <input id="pax" inputmode="numeric" pattern="\d*" placeholder="2" />
              </div>
            </div>

            <div class="row">
              <div>
                <label>Lead ID</label>
                <input id="leadId" inputmode="numeric" pattern="\d*" placeholder="55471" />
              </div>
              <div>
                <label>Start date (default: today)</label>
                <input id="startDate" type="date" />
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Dates</label>
                <input id="dates" placeholder="Sep 07 - Sep 15 or 2025-09-02 ‚Üí 2025-09-10" />
              </div>
            </div>

            <div class="row single">
              <div>
                <label>Notes</label>
                <textarea id="notes" rows="3" placeholder="Preferences, budget, route, remarks‚Ä¶"></textarea>
              </div>
            </div>
          </div>

          <div class="right" style="margin-top:8px">
            <button type="button" class="ghost" id="resetForm">Clear</button>
            <button class="primary" type="button" id="saveCustomer">Save Customer</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Customers -->
    <section class="card">
      <div class="hd" style="gap:8px">
        <strong>Customers</strong>
        <button id="openAdd" class="btn-icon add-btn" title="Add customer" aria-label="Add customer">Ôºã</button>
        <div class="space"></div>
        <input id="search" placeholder="Search name, email, phone‚Ä¶" />
        <select id="statusFilter" title="Filter by status" style="max-width:160px">
          <option value="">All</option>
          <option value="unreached">Unreached</option>
          <option value="reached">Reached</option>
        </select>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="tiny">Total</div><div id="kTotal" class="num">0</div></div>
          <div class="box"><div class="tiny">Unreached</div><div id="kUn" class="num">0</div></div>
          <div class="box"><div class="tiny">Reached</div><div id="kRe" class="num">0</div></div>
          <div class="box"><div class="tiny">Open tasks</div><div id="kTasks" class="num">0</div></div>
        </div>

        <div class="mt16 customers-scroll" style="margin-top:12px; overflow-x:auto; max-height:50vh; overflow-y:auto;">
          <table class="tbl" id="clientsTbl">
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Status</th>
                <th>Next Action Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="mt16 right">
          <button class="btn-danger" id="wipeAll" title="Delete all data">Wipe All</button>
        </div>

        <div class="mt16 tiny">Rules:
          <ul>
            <li>Unreached: 5 working days. Day 1 has 2 emails (‚ÄúIntro & Info‚Äù and ‚Äú3PQ + Feedback‚Äù). Each day: 2 Calls (2nd becomes ‚ÄúCall + Voicemail‚Äù), 1 SMS.</li>
            <li>Reached: Phase 1 (3 working days), then +3d, +5d, +7d, +7d, +7d (working days respected). Each day: 2 Calls, 1 SMS, 1 Email.</li>
            <li>Manual Next FU: clears future tasks & schedules one 2 Calls + 1 SMS + 1 Email day on the picked date.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Agenda + Calendar -->
    <div class="row agenda-layout">
      <!-- Agenda -->
      <section class="card" id="actionsCard">
        <div class="hd"><strong>Agenda</strong></div>
        <div class="bd">
          <div class="toolbar">
            <button type="button" id="viewToday" class="primary">Today</button>
            <button type="button" id="viewWeek">Next 7 days</button>
            <input type="date" id="agendaDate" />
            <input type="text" id="agendaFilter" class="mono" placeholder="Filter by client‚Ä¶" style="max-width:220px" />
            <button type="button" id="agendaFilterClear" title="Clear filter">Clear</button>

            <div class="space"></div>
            <div class="pill">Sort:</div>
            <div class="seg" role="group" aria-label="Sort tasks">
              <button type="button" id="sortClient"  aria-pressed="false">By client</button>
              <button type="button" id="sortType"    class="primary" aria-pressed="true">By task</button>
            </div>

            <div class="space"></div>
            <button type="button" id="sendDueEmails" class="tiny" title="Open mail drafts for today‚Äôs unreached emails">Send Due Emails</button>

            <div class="space"></div>
            <button type="button" id="enableNotifs" class="tiny" title="Enable desktop notifications">üîî Enable</button>
            <button type="button" id="testNotif" class="tiny" title="Send a test notification">Test</button>
            <span id="notifStatus" class="pill">Checking‚Ä¶</span>

            <div class="badge">Today's Progress
              <span class="space"></span>
              <span id="progressPct" class="mono">0%</span>
            </div>
          </div>

          <div class="mt12 progress"><span id="progressBar"></span></div>
          <div id="agenda" class="mt12"></div>
        </div>
      </section>

      <!-- Calendar -->
      <section class="card" id="calendarCard">
        <div class="hd cal-hd">
          <strong>Calendar</strong>
          <div class="cal-month tiny">
            <button class="btn-icon" id="calPrev" title="Previous month">‚óÄ</button>
            <span id="calTitle" class="mono"></span>
            <button class="btn-icon" id="calNext" title="Next month">‚ñ∂</button>
          </div>
          <div class="space"></div>
          <button class="settings-btn" id="calSettingsBtn" title="Calendar settings">‚öôÔ∏è Settings</button>
        </div>
        <div class="bd">
          <div id="calSettings" style="display:none">
            <div class="tiny" style="font-weight:600; margin-bottom:6px">Working days (auto-scheduled tasks):</div>
            <div class="wdays">
              <label class="cell"><input type="checkbox" id="wd_mon"><span>Mon</span></label>
              <label class="cell"><input type="checkbox" id="wd_tue"><span>Tue</span></label>
              <label class="cell"><input type="checkbox" id="wd_wed"><span>Wed</span></label>
              <label class="cell"><input type="checkbox" id="wd_thu"><span>Thu</span></label>
              <label class="cell"><input type="checkbox" id="wd_fri"><span>Fri</span></label>
              <label class="cell"><input type="checkbox" id="wd_sat"><span>Sat</span></label>
              <label class="cell"><input type="checkbox" id="wd_sun"><span>Sun</span></label>
            </div>

            <div class="switch-row">
              <label style="display:flex; align-items:center; gap:8px">
                <input type="checkbox" id="moveOffDays" />
                Move auto tasks off non-working days
              </label>
              <button id="saveCalSettings" class="primary" style="height:34px">Save</button>
            </div>

            <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">
            <div class="tiny" style="font-weight:600; margin-bottom:6px">Date-specific overrides:</div>
            <div class="ovr">
              <input type="date" id="ovrDate" />
              <select id="ovrType">
                <option value="work">Mark as Working</option>
                <option value="off">Mark as Off</option>
              </select>
              <button id="addOverride">Add</button>
              <div class="tiny">These override weekday rules for the exact date.</div>
            </div>
            <ul id="overrideList" class="ovr-list"></ul>
          </div>

          <div id="calendarGrid"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Toast container -->
  <div id="toaster" aria-live="polite"></div>

<script>
(function(){
  'use strict';

  /* ========= Helpers ========= */
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const storeKey  = 'followup_crm_v21';
  const THEME_KEY = 'followup_crm_theme';
  const SORT_KEY  = 'followup_crm_sort';

  // Instant parse on paste into the lead blob
  const leadBlobEl = $('#leadBlob');
  leadBlobEl.addEventListener('paste', () => {
    requestAnimationFrame(() => {
      const has = (leadBlobEl.value || '').trim();
      if (!has) return;
      parseBlob({ onlyFillEmpty: false });
      toast('Parsed from paste. Review & save.');
    });
  });

  function flashAgendaDate(){
    const el = document.getElementById('agendaDate');
    if(!el) return;
    el.classList.remove('glow');
    void el.offsetWidth;
    el.classList.add('glow');
    clearTimeout(flashAgendaDate._t);
    flashAgendaDate._t = setTimeout(()=> el.classList.remove('glow'), 950);
  }

  function uid(){ return 'id'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
  function fmt(d){ if(!(d instanceof Date)) d=new Date(d); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function parseLocalYMD(ymd){ if(!ymd) return today(); const [y,m,d]=ymd.split('-').map(Number); const dt=new Date(y,(m||1)-1,d||1); dt.setHours(0,0,0,0); return dt; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function truncate(s, n=90){ if(!s) return ''; return s.length>n ? s.slice(0,n-1)+'‚Ä¶' : s; }

  /* ========= Toast ========= */
  function toast(msg, kind='ok', ms=1800){
    const host = document.getElementById('toaster') || (()=>{ const d=document.createElement('div'); d.id='toaster'; document.body.appendChild(d); return d; })();
    const el = document.createElement('div');
    el.className = 'toast ' + (kind==='err'?'err':'ok');
    el.innerHTML = (kind==='err' ? '‚ö†Ô∏è' : '‚úÖ') + ' ' + (msg||'');
    host.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=> el.remove(), 220); }, ms);
  }

  /* ========= Theme ========= */
  function applyTheme(t){ document.body.classList.toggle('light', t==='light'); $('#themeToggle').textContent = t==='light' ? 'üåô Dark' : '‚òÄÔ∏è Light'; }
  applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
  $('#themeToggle').addEventListener('click', ()=>{
    const next = document.body.classList.contains('light') ? 'dark' : 'light';
    localStorage.setItem(THEME_KEY, next); applyTheme(next);
  });

  /* ========= Add/Edit modal ========= */
  function closeAddModal(){
    const m = document.getElementById('addModal');
    const card = document.getElementById('addCard');
    if (m){ m.classList.remove('open'); m.style.display='none'; }
    if (card){ card.style.display='none'; }
    document.body.classList.remove('modal-open');
  }
  function openAddModal(asNew=false){
    const m = document.getElementById('addModal');
    const card = document.getElementById('addCard');
    if(!m || !card) return;
    if(asNew){
      document.getElementById('clientForm')?.reset();
      $('#clientId').value='';
      $('#leadBlob').value='';
      // collapse advanced by default
      $('#advFields').style.display='none';
      $('#advToggle').textContent='‚ñ∏ More fields';
    }
    card.style.display='block';
    m.style.display='flex'; m.classList.add('open');
    document.body.classList.add('modal-open');
    setTimeout(()=>{ try{ document.getElementById('name').focus(); }catch(_){} }, 50);
  }
  function initAddModal(){
    const card = document.getElementById('addCard');
    if(!card) return;
    let modal = document.createElement('div');
    modal.id = 'addModal';
    modal.className = 'modal';
    modal.style.display = 'none';
    document.body.appendChild(modal);
    modal.appendChild(card);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closeAddModal(); });
    document.getElementById('openAdd')?.addEventListener('click', ()=> openAddModal(true));
    document.getElementById('closeAdd')?.addEventListener('click', closeAddModal);
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAddModal(); });
  }

  /* ========= State ========= */
  function defaults(){
    return {
      clients: [],
      tasks: [],
      settings: {
        workingDays: { mon:true, tue:true, wed:true, thu:true, fri:true, sat:false, sun:false },
        moveOffDays: true,
        overrides: {}
      }
    };
  }
  function load(){
    try{
      const s = JSON.parse(localStorage.getItem(storeKey) || 'null') || defaults();
      if(!s.settings) s.settings = defaults().settings;
      return s;
    }catch(e){ return defaults(); }
  }
  const state = load();
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); refresh(); buildCalendar(); }

  /* ========= Working days logic ========= */
  function weekdayIndex(dt){ const js=dt.getDay(); return (js+6)%7; } // Mon=0
  function isWorkingDay(dt){
    const ymd = fmt(dt);
    const ov = state.settings.overrides[ymd];
    if(ov==='work') return true; if(ov==='off') return false;
    const map=['mon','tue','wed','thu','fri','sat','sun'];
    return !!state.settings.workingDays[ map[weekdayIndex(dt)] ];
  }
  function hasAnyWorkingDay(){
    const wd = state.settings.workingDays || {};
    return !!(wd.mon||wd.tue||wd.wed||wd.thu||wd.fri||wd.sat||wd.sun);
  }
  function nextWorkingDay(date){ let d=new Date(date); if (!hasAnyWorkingDay()) return d; for (let i=0;i<31 && !isWorkingDay(d); i++) d = addDays(d,1); return d; }
  function stepByWorkingDays(fromDate, steps){ let d=new Date(fromDate); for(let i=0;i<steps;i++) d=nextWorkingDay(addDays(d,1)); return d; }
  function adjustAutoDateIfNeeded(dt){ if(!state.settings.moveOffDays || !hasAnyWorkingDay()) return dt; let d=new Date(dt); for (let i=0;i<31 && !isWorkingDay(d); i++) d=addDays(d,1); return d; }

  /* ========= Lead Parser ========= */
  function parseLeadBlob(text){
    const raw = (text||'').replace(/\r/g,'\n');
    const whole = raw.replace(/\t/g,'  ').replace(/[ \u00A0]+/g,' ').replace(/\n{2,}/g,'\n').trim();

    const email = (whole.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)||[''])[0] || '';

    let noDates = whole
      .replace(/\b\d{4}-\d{2}-\d{2}[ T]\d{2}:\d{2}(?::\d{2})?\b/g,' ')
      .replace(/\b\d{4}-\d{2}-\d{2}\b/g,' ');

    const phoneCandidates = (noDates.match(/\+?\d[\d\s().-]{6,}\d/g)||[])
      .map(s=>s.trim())
      .filter(s=>!/:/.test(s))
      .filter(s=>{
        const digits = s.replace(/\D/g,'');
        return digits.length>=10 && digits.length<=15;
      });
    const phone = phoneCandidates[0] || '';

    let name = '';
    const nm = whole.match(/\bnew\b[\s:]+([^\n\t]+?)(?=\s+(?:RT|OW|[A-Z]{2,3}\b)|\t|\n|$)/i);
    if(nm) name = nm[1].trim();
    if(!name && email){
      const local = email.split('@')[0];
      const parts = local.split(/[._-]+/);
      name = parts.length>1
        ? parts.map(p=>p.charAt(0).toUpperCase()+p.slice(1)).join(' ')
        : local.charAt(0).toUpperCase()+local.slice(1);
    }

    const routeMatch = whole.match(/\b[A-Z]{3}(?:\s*[-‚Äì‚Äî‚Üí]\s*[A-Z]{3})+\b/);
    const route = routeMatch ? routeMatch[0].replace(/\s*[-‚Äì‚Äî‚Üí]\s*/g,'-').toUpperCase() : '';

    const monthName = "(Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:t|tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)";
    const mDates = whole.match(new RegExp(`\\b${monthName}\\s+\\d{1,2}(?:,\\s*\\d{4})?\\s*(?:-|‚Äì|‚Äî|to|‚Üí)\\s*(?:${monthName}\\s+)?\\d{1,2}(?:,\\s*\\d{4})?\\b`,'i'));
    let dates = mDates ? mDates[0].replace(/\s{2,}/g,' ').trim() : '';
    if(!dates){
      const mYMD = whole.match(/\b\d{4}-\d{2}-\d{2}\s*(?:‚Üí|to|‚Äì|‚Äî|-)\s*\d{4}-\d{2}-\d{2}\b/);
      if(mYMD) dates = mYMD[0].replace(/\s+/g,' ');
    }

    let pax = '';
    const mpax = whole.match(/\b(?:pax|passengers?)\s*[:=]?\s*(\d{1,2})\b/i) || whole.match(/\bx\s*(\d{1,2})\b/i);
    if(mpax) pax = mpax[1];

    // Lead ID (4‚Äì9 digits not part of phone/date/pax)
    let leadId = '';
    try{
      const phoneDigits = (phone || '').replace(/\D/g,'');
      const paxDigits   = (pax   || '').replace(/\D/g,'');
      const idCandidates = Array.from(whole.matchAll(/(?:^|[\s\t:>])(\d{4,9})(?=$|[\s\t<])/g)).map(m => m[1]);
      for(const cand of idCandidates){
        if (cand === paxDigits) continue;
        if (phoneDigits && phoneDigits.includes(cand)) continue;
        if (/^\d{8}$/.test(cand)) continue; // likely yyyymmdd
        leadId = cand; break;
      }
    }catch(_){}

    return { name, email, phone, route, dates, pax, leadId, notes:'' };
  }

  /* ========= Contact link helpers ========= */
  const CALL_LINK_MODE = 'tel';
  const EMAIL_MODE     = 'gmail';
  function phoneHref(num){
    const clean=(num||'').replace(/[^\d+]/g,'');
    return CALL_LINK_MODE==='callto' ? `callto:${clean}` : `tel:${clean}`;
  }
  function emailHref(addr, subject='', body=''){
    const enc = s => encodeURIComponent(s || '');
    return EMAIL_MODE === 'gmail'
      ? `https://mail.google.com/mail/?view=cm&fs=1&to=${enc(addr)}&su=${enc(subject)}&body=${enc(body)}&tf=1`
      : `mailto:${addr}?subject=${enc(subject)}&body=${enc(body)}`;
  }

  /* ========= Scheduling ========= */
  const ACTIONS_UNREACHED = d => ({ calls:2, voicemail:1, sms:1, emails: d===1?2:1 });
  const ACTIONS_REACHED   = { calls:2, voicemail:1, sms:1, emails:1 };

  function addTask(t){
    t.id = t.id || uid();
    t.status = t.status || 'open';
    const exists = state.tasks.some(x =>
      x.clientId===t.clientId && x.date===t.date && x.type===t.type &&
      (x.title||'')===(t.title||'') && (x.source||'')===(t.source||''));
    if(!exists) state.tasks.push(t);
  }

  function genDayTasks(client, date, a, label){
    const todayY = fmt(today());
    if(date < todayY) return;
    const base = {clientId:client.id, clientName:client.name, date, source:'auto', label};
    if (a.calls >= 1) addTask({...base, type:'call',   title:'Call'});
    if (a.voicemail >= 1) addTask({...base, type:'callvm', title:'Call + Voicemail'});
    else if (a.calls >= 2) addTask({...base, type:'call',   title:'Call 2'});
    for (let i=1;i<=a.sms;i++) addTask({...base, type:'sms', title:'SMS'});
    if (label && label.startsWith('Unreached Day 1')){
      addTask({...base, type:'email', title:'Introduction & Info Emails'});
      addTask({...base, type:'email', title:'3PQ + Feedback Request Email'});
    } else {
      for (let i=1;i<=a.emails;i++) addTask({...base, type:'email', title:'Email'});
    }
  }

  function scheduleUnreached(client){
    const start0 = client.startDate ? parseLocalYMD(client.startDate) : today();
    let day1 = nextWorkingDay(start0);
    for(let dayNum=1; dayNum<=5; dayNum++){
      const date = fmt(adjustAutoDateIfNeeded(day1));
      genDayTasks(client, date, ACTIONS_UNREACHED(dayNum), `Unreached Day ${dayNum}`);
      if(dayNum<5) day1 = stepByWorkingDays(day1, 1);
    }
  }

  function scheduleReached(client){
    const start0 = client.reachedStart ? parseLocalYMD(client.reachedStart) : today();
    const p1d1 = adjustAutoDateIfNeeded(nextWorkingDay(start0));
    const p1d2 = adjustAutoDateIfNeeded(stepByWorkingDays(p1d1, 1));
    const p1d3 = adjustAutoDateIfNeeded(stepByWorkingDays(p1d2, 1));
    genDayTasks(client, fmt(p1d1), ACTIONS_REACHED, `Phase 1 (Day 1/3)`);
    genDayTasks(client, fmt(p1d2), ACTIONS_REACHED, `Phase 1 (Day 2/3)`);
    genDayTasks(client, fmt(p1d3), ACTIONS_REACHED, `Phase 1 (Day 3/3)`);
    const gaps = [3,5,7,7,7];
    let last = p1d3;
    for (let i=0;i<gaps.length;i++){
      let target = addDays(last, gaps[i]);
      target = adjustAutoDateIfNeeded(target);
      genDayTasks(client, fmt(target), ACTIONS_REACHED, `Phase ${i+2}`);
      last = target;
    }
  }

  function clearFutureTasksForClientFrom(id, fromDate){ const f = fmt(fromDate); state.tasks = state.tasks.filter(t=> !(t.clientId===id && t.source==='auto' && t.status!=='done' && t.date >= f)); }
  function clearManualTasksForClient(id){ state.tasks = state.tasks.filter(t=> !(t.clientId===id && t.source==='manual' && t.status!=='done')); }
  function markDone(id, done){ const t = state.tasks.find(x=>x.id===id); if(!t) return; t.status = done? 'done':'open'; save(); }
  function deleteTask(id){ state.tasks = state.tasks.filter(t=>t.id!==id); save(); }

  function regenerateAutoOpenTasksFromAnchors(){
    const from = fmt(today());
    state.tasks = state.tasks.filter(t => !(t.source==='auto' && t.status!=='done' && t.date >= from));
    for(const c of state.clients){ if(c.status==='unreached') scheduleUnreached(c); else scheduleReached(c); }
    save();
  }

  /* ========= Customers table ========= */
  function clientById(id){ return state.clients.find(c=>c.id===id); }
  function nextActionDateForClient(id){ const open = state.tasks.filter(t=>t.clientId===id && t.status==='open').sort((a,b)=> a.date.localeCompare(b.date)); return open[0]?.date || '‚Äî'; }

  function refresh(){
    $('#kTotal').textContent = state.clients.length;
    $('#kUn').textContent = state.clients.filter(c=>c.status==='unreached').length;
    $('#kRe').textContent = state.clients.filter(c=>c.status==='reached').length;
    $('#kTasks').textContent = state.tasks.filter(t=>t.status==='open').length;

    const body = $('#clientsTbl tbody'); body.innerHTML = '';
    const query = ($('#search').value||'').toLowerCase();
    const sflt  = ($('#statusFilter').value||'').toLowerCase();
    [...state.clients]
      .sort((a,b)=>a.name.localeCompare(b.name))
      .filter(c => (!sflt || c.status===sflt))
      .filter(c => [c.name,c.email,c.phone,(c.notes||''),(c.route||''),(c.dates||''),(c.pax||''),(c.leadId||'')].join(' ').toLowerCase().includes(query))
      .forEach(c => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-rowid', c.id);
        const contactHtml = `
           ${c.email ? `<a href="${emailHref(c.email,'Follow-up','Hi ‚Ä¶')}" target="_blank" rel="noopener">${escapeHtml(c.email)}</a> <button class="copy-btn" data-copy="${escapeHtml(c.email)}" data-what="email" title="Copy email" aria-label="Copy email">‚ßâ</button>` : '-'}
           <br>
          ${c.phone ? `<a href="${phoneHref(c.phone)}">${escapeHtml(c.phone)}</a> <button class="copy-btn" data-copy="${escapeHtml(c.phone)}" data-what="phone" title="Copy phone" aria-label="Copy phone">‚ßâ</button>` : '-'}`;

        tr.innerHTML = `
          <td data-label="Name">
            <strong>${escapeHtml(c.name)}</strong>
            <div class="tiny mono note-preview" data-act="note" data-id="${c.id}" title="Click to expand notes">
              ${c.notes ? escapeHtml(truncate(c.notes)) : ''}
            </div>
          </td>
          <td data-label="Contact" class="tiny">${contactHtml}</td>
          <td data-label="Status"><span class="badge">${c.status}</span></td>
          <td data-label="Next Action">${nextActionDateForClient(c.id)}</td>
          <td data-label="Actions" class="actions">
            <button type="button" class="btn-icon" data-act="note"  data-id="${c.id}" title="Show notes" aria-label="Show notes">üóíÔ∏è</button>
            <button type="button" class="btn-icon" data-act="manual" data-id="${c.id}" title="Set next FU (manual)" aria-label="Manual next FU">üìÖ</button>
            <button type="button" class="btn-icon" data-act="edit"  data-id="${c.id}" title="Edit" aria-label="Edit">üñäÔ∏è</button>
            <button type="button" class="btn-icon" data-act="reach" data-id="${c.id}" title="${c.status==='unreached'?'Mark Reached':'Mark Unreached'}" aria-label="${c.status==='unreached'?'Mark Reached':'Mark Unreached'}">${c.status==='unreached'?'‚úÖ':'‚Ü©Ô∏è'}</button>
            <button type="button" class="btn-icon" data-act="del"   data-id="${c.id}" title="Delete" aria-label="Delete">üóëÔ∏è</button>
          </td>`;
        body.appendChild(tr);
      });
    renderAgenda();
    updateProgress();
    try{ buildClientOptionsForPopover(); }catch(_){}
  }

  function toggleNotesRow(id){
    const existing = document.querySelector(`.note-row[data-for="${id}"]`);
    if(existing){ existing.remove(); return; }
    const tr = document.querySelector(`tr[data-rowid="${id}"]`);
    if(!tr) return;
    const c = clientById(id) || {};
    const row = document.createElement('tr'); row.className='note-row'; row.setAttribute('data-for', id);
    const td = document.createElement('td'); td.colSpan = 5;
    const chips = [
      c.route ? `<span class="pill">Route: ${escapeHtml(c.route)}</span>` : '',
      c.dates ? `<span class="pill">Dates: ${escapeHtml(c.dates)}</span>` : '',
      c.pax   ? `<span class="pill">Pax: ${escapeHtml(String(c.pax))}</span>` : '',
      c.leadId? `<span class="pill">Lead: ${escapeHtml(String(c.leadId))}</span>` : ''
    ].filter(Boolean).join(' ');
    td.innerHTML = `<div class="tiny slab">${chips || ''}<div>${escapeHtml(c.notes || 'No notes yet.')}</div></div>`;
    row.appendChild(td); tr.after(row);
  }

  $('#clientsTbl').addEventListener('click', e=>{
    const btn = e.target.closest('button[data-act]'); if(!btn) return;
    const id = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const c = clientById(id);

    if(act==='note'){ toggleNotesRow(id); return; }
    if(act==='manual'){
      const open = document.querySelector(`.manual-row[data-for="${id}"]`);
      if(open){ $$('.manual-row').forEach(n=>n.remove()); return; }
      openManualRow(id); return;
    }
    if(act==='manual-apply'){
      const date = document.getElementById(`manualDate_${id}`)?.value || '';
      const shouldClear = document.getElementById(`manualClear_${id}`)?.checked ?? true;
      const notes = document.getElementById(`manualNotes_${id}`)?.value || '';
      const rmPrev = document.getElementById(`manualClearPrev_${id}`)?.checked ?? false;
      scheduleManualFU(c, date, shouldClear, notes, rmPrev);
      $$('.manual-row').forEach(n=>n.remove()); return;
    }
    if(act==='manual-cancel'){ $$('.manual-row').forEach(n=>n.remove()); return; }

    if (act==='edit'){
      if(!c){ return; }
      $('#clientId').value = c.id;
      $('#name').value  = c.name  || '';
      $('#email').value = c.email || '';
      $('#phone').value = c.phone || '';
      $('#status').value = c.status;
      $('#startDate').value = c.startDate || '';
      $('#route').value = c.route || '';
      $('#dates').value = c.dates || '';
      $('#pax').value   = c.pax   || '';
      $('#leadId').value = c.leadId || '';
      $('#notes').value = c.notes || '';
      // collapse advanced by default
      $('#advFields').style.display='none';
      $('#advToggle').textContent='‚ñ∏ More fields';
      openAddModal(false);
      return;
    }

    if(act==='reach'){
      c.status = c.status === 'unreached' ? 'reached' : 'unreached';
      if(c.status === 'reached'){
        c.reachedStart = fmt(today());
        clearFutureTasksForClientFrom(c.id, today());
        scheduleReached(c);
      }else{
        c.startDate = fmt(today());
        clearFutureTasksForClientFrom(c.id, today());
        scheduleUnreached(c);
      }
      save(); return;
    }
    if(act==='del'){
      if(confirm('Delete this customer and all their tasks?')){
        state.clients = state.clients.filter(x=>x.id!==id);
        state.tasks   = state.tasks.filter(t=>t.clientId!==id);
        save();
      }
      return;
    }
  });

  /* ========= Manual FU ========= */
  function openManualRow(id){
    $$('.manual-row').forEach(n=>n.remove());
    const tr = document.querySelector(`tr[data-rowid="${id}"]`);
    if(!tr) return;
    const row = document.createElement('tr');
    row.className = 'manual-row'; row.setAttribute('data-for', id);
    const td = document.createElement('td'); td.colSpan = 5;
    td.innerHTML = `
      <div class="tiny slab flex-row">
        <span>Manual next follow-up for <b>${escapeHtml(clientById(id)?.name||'Client')}</b>:</span>
        <input type="date" id="manualDate_${id}" min="${fmt(today())}" />
        <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="manualClear_${id}" checked /> Clear ALL future auto tasks</label>
        <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="manualClearPrev_${id}" checked /> Remove previous manual tasks</label>
        <input type="text" id="manualNotes_${id}" placeholder="Optional notes" style="min-width:220px" />
        <span>Creates: 2 Calls, 1 SMS, 1 Email.</span>
        <span class="space"></span>
        <button class="primary" data-act="manual-apply" data-id="${id}">Schedule</button>
        <button data-act="manual-cancel" data-id="${id}">Cancel</button>
      </div>`;
    row.appendChild(td); tr.after(row);
  }
  function scheduleManualFU(client, ymd, shouldClear=true, notes='', removePrevManual=false){
    const date = fmt(parseLocalYMD(ymd || fmt(today())));
    if(shouldClear) clearFutureTasksForClientFrom(client.id, today());
    if(removePrevManual) clearManualTasksForClient(client.id);
    const base = {clientId:client.id, clientName:client.name, date, source:'manual', label:'Manual FU', notes};
    addTask({...base, type:'call',  title:'Call'});
    addTask({...base, type:'call',  title:'Call 2'});
    addTask({...base, type:'sms',   title:'SMS'});
    addTask({...base, type:'email', title:'Email'});
    save();
  }

  /* ========= Agenda ========= */
  let currentAgendaDate = today();
  let agendaFilter = '';
  let sortMode = localStorage.getItem(SORT_KEY) || 'type';  // 'type' | 'client'

  function setAgendaFilter(val){
    agendaFilter = (val || '').trim().toLowerCase();
    renderAgenda();
    buildCalendar();
  }

  function typeOrder(t){ return ({call:1, callvm:2, voicemail:3, sms:4, email:5, custom:6}[t]||9); }
  function clientDisplayName(t){ return t.clientName || (t.clientId ? (clientById(t.clientId)||{}).name : '') || ''; }
  function clientNameLower(t){ return clientDisplayName(t).toLowerCase(); }
  function sortTasksForMode(a,b){
    const byType = typeOrder(a.type) - typeOrder(b.type);
    const byName = clientNameLower(a).localeCompare(clientNameLower(b));
    const byTitle = (a.title||'').localeCompare(b.title||'');
    return sortMode==='client' ? (byName || byType || byTitle) : (byType || byName || byTitle);
  }
  function matchesFilter(t){ return !agendaFilter || clientNameLower(t).includes(agendaFilter); }

  function renderTask(t){
    const div = document.createElement('div');
    div.className = 'agenda-item'+(t.status==='done'?' done':'');
    const icon = { call:'üìû', callvm:'üìûüó£Ô∏è', voicemail:'üó£Ô∏è', sms:'üí¨', email:'‚úâÔ∏è', custom:'üìù' }[t.type] || '‚Ä¢';
    const client = t.clientName || '';
    let contactHtml = '';
    if(t.clientId){
      const c = clientById(t.clientId) || {};
      if((t.type==='call' || t.type==='callvm') && c.phone){
        const href = phoneHref(c.phone);
        contactHtml = `<span class="pill"><a class="mono" href="${href}">${escapeHtml(c.phone)}</a><button class="copy-btn" data-copy="${escapeHtml(c.phone)}" data-what="phone" title="Copy phone" aria-label="Copy phone">‚ßâ</button></span>`;
      } else if(t.type==='sms' && c.phone){
        contactHtml = `<span class="pill"><a class="mono" href="${phoneHref(c.phone)}">${escapeHtml(c.phone)}</a><button class="copy-btn" data-copy="${escapeHtml(c.phone)}" data-what="phone" title="Copy phone" aria-label="Copy phone">‚ßâ</button></span>`;
      } else if(t.type==='email' && c.email){
        const href = emailHref(c.email,'Follow-up','Hi ‚Ä¶');
        contactHtml = `<span class="pill"><a class="mono" href="${href}" target="_blank" rel="noopener">${escapeHtml(c.email)}</a><button class="copy-btn" data-copy="${escapeHtml(c.email)}" data-what="email" title="Copy email" aria-label="Copy email">‚ßâ</button></span>`;
      }
    }
    div.innerHTML = `
      <input type="checkbox" ${t.status==='done'?'checked':''} data-taskid="${t.id}"/>
      <div>
        <div><strong>${icon} ${escapeHtml(t.title)}</strong>
          ${client?`<span class="pill">${escapeHtml(client)}</span>`:''}
          ${contactHtml}
        </div>
        <div class="tiny">${escapeHtml(t.label||'')}</div>
      </div>
      <div class="tiny mono">${t.date} <button class="btn-icon" data-del="${t.id}" title="Delete task">üóëÔ∏è</button></div>`;
    div.querySelector('input').addEventListener('change', ev=>{ markDone(t.id, ev.target.checked); });
    return div;
  }

  function buildAgenda(date){
    const f = fmt(date);
    const cont = $('#agenda');
    const items = state.tasks.filter(t=> t.date===f && matchesFilter(t)).sort(sortTasksForMode);
    cont.innerHTML = '';
    if(items.length===0){ cont.innerHTML = `<div class="tiny">No tasks for ${f}.</div>`; updateProgress(); return; }
    items.forEach(t=>cont.appendChild(renderTask(t)));
    updateProgress();
  }

  function buildAgendaRange(from, to){
    const cont = $('#agenda'); cont.innerHTML = '';
    const days = Math.ceil((to-from)/86400000)+1;
    for(let i=0;i<days;i++){
      const d = addDays(from,i), f = fmt(d);
      const items = state.tasks.filter(t=> t.date===f && matchesFilter(t)).sort(sortTasksForMode);
      const head = document.createElement('div'); head.className = 'tiny'; head.innerHTML = `<div class="badge mono">${f}</div>`;
      cont.appendChild(head);
      if(items.length===0){ const none = document.createElement('div'); none.className='tiny'; none.textContent='No tasks'; cont.appendChild(none); }
      else items.forEach(t=>cont.appendChild(renderTask(t)));
    }
    updateProgress();
  }

  function updateProgress(){
    const f = fmt(today());
    const todays = state.tasks.filter(t=>t.date===f);
    const done = todays.filter(t=>t.status==='done').length;
    const total = todays.length || 1;
    const pct = Math.round((done/total)*100);
    $('#progressPct').textContent = pct+'%';
    $('#progressBar').style.width = pct+'%';
  }

  $('#agenda').addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-del]'); if(!btn) return;
    const id = btn.getAttribute('data-del');
    if(confirm('Delete this task?')) deleteTask(id);
  });

  // Agenda controls
  let renderAgenda = ()=> buildAgenda(currentAgendaDate);
  function setSortButtons(){
    $('#sortClient').classList.toggle('primary',  sortMode === 'client');
    $('#sortType').classList.toggle('primary',    sortMode === 'type');
    $('#sortClient').setAttribute('aria-pressed', String(sortMode==='client'));
    $('#sortType').setAttribute('aria-pressed',   String(sortMode==='type'));
  }
  function setAgendaMode(mode){
    $('#viewToday').classList.toggle('primary', mode === 'today');
    $('#viewWeek').classList.toggle('primary', mode === 'week');
  }
  $('#sortClient').addEventListener('click',  ()=>{ sortMode='client'; localStorage.setItem(SORT_KEY, sortMode); setSortButtons(); renderAgenda(); });
  $('#sortType').addEventListener('click',    ()=>{ sortMode='type';   localStorage.setItem(SORT_KEY, sortMode); setSortButtons(); renderAgenda(); });

  $('#viewToday').addEventListener('click', ()=>{ currentAgendaDate=today(); renderAgenda=()=>buildAgenda(currentAgendaDate); setAgendaMode('today'); $('#agendaDate').value=''; renderAgenda(); });
  $('#viewWeek').addEventListener('click', ()=>{ const from=today(); const to=addDays(today(),6); renderAgenda=()=>buildAgendaRange(from,to); setAgendaMode('week'); $('#agendaDate').value=''; renderAgenda(); });
  $('#agendaDate').addEventListener('change', ()=>{ const d=$('#agendaDate').value?parseLocalYMD($('#agendaDate').value):today(); currentAgendaDate=d; renderAgenda=()=>buildAgenda(currentAgendaDate); setAgendaMode(null); renderAgenda(); });
  $('#agendaFilter').addEventListener('input', ()=> setAgendaFilter($('#agendaFilter').value));
  $('#agendaFilterClear').addEventListener('click', ()=>{ $('#agendaFilter').value=''; setAgendaFilter(''); });
  setSortButtons();

  /* ========= Batch Emails for Unreached today ========= */
  function emailTemplateFor(t, client){
    if((t.label||'').startsWith('Unreached Day 1')) return {subject:'Welcome ‚Äî next steps', body:`Hi ${client?.name||''},\n\nGreat to connect. Here‚Äôs the info we discussed‚Ä¶\n\nBest,\n`};
    return { subject:'Quick follow-up', body:`Hi ${client?.name||''},\n\nJust checking in on ‚Ä¶\n\nBest,\n` };
  }
  function collectDueUnreachedEmails(){
    const f = fmt(today());
    return state.tasks.filter(t=>{
      if (t.date!==f || t.status==='done' || t.type!=='email') return false;
      const c = clientById(t.clientId);
      return c && c.status==='unreached' && c.email;
    });
  }
  function launchBatchMailtos(tasks){
    let i=0; (function openNext(){
      if (i>=tasks.length) return;
      const t = tasks[i++]; const c = clientById(t.clientId);
      const {subject, body} = emailTemplateFor(t, c||{});
      const href = emailHref(c.email, subject, body);
      window.open(href, '_blank'); setTimeout(openNext, 600);
    })();
  }
  $('#sendDueEmails').addEventListener('click', ()=>{
    const due = collectDueUnreachedEmails();
    if (!due.length){ alert('No unreached emails due today.'); return; }
    if (!confirm(`Open ${due.length} email compose window(s) now?`)) return;
    launchBatchMailtos(due);
  });

  /* ========= Notifications ========= */
  const NOTIFY_KEY = 'followup_crm_notified_today';
  function notifSupported(){ return typeof window.Notification === 'function'; }
  function isSecure(){ return window.isSecureContext || location.protocol==='https:' || ['localhost','127.0.0.1','[::1]'].includes(location.hostname); }
  function setNotifStatus(txt){ const el=$('#notifStatus'); if(el) el.textContent = txt; }
  function fmtToday(){ return fmt(today()); }
  function notifyTask(t){
    if (!notifSupported() || Notification.permission!=='granted') return;
    try{
      const tag = t.id || ('rand-'+Date.now()+'-'+Math.random().toString(36).slice(2));
      const n = new Notification(`${t.title}${t.clientName ? ' ‚Äî '+t.clientName : ''}`, {
        body: `${t.label||''} ‚Ä¢ ${t.date}${t.notifyTime?(' @ '+t.notifyTime):''}`,
        tag, renotify:true, silent:false, requireInteraction: !!t.requireInteraction
      });
      n.onclick = () => { try{ window.focus(); }catch(_){} };
    }catch(e){}
  }
  function getNotifiedSet(){
    const f = fmtToday();
    try { const o = JSON.parse(localStorage.getItem(NOTIFY_KEY) || '{}'); return o[f] ? new Set(o[f]) : new Set(); } catch(e){ return new Set(); }
  }
  function saveNotifiedSet(set){
    const f = fmtToday();
    let o = {};
    try { o = JSON.parse(localStorage.getItem(NOTIFY_KEY) || '{}'); } catch(e){}
    o[f] = Array.from(set);
    localStorage.setItem(NOTIFY_KEY, JSON.stringify(o));
  }
  function combineYmdTimeLocal(ymd, hhmm){
    const [y,m,d] = (ymd||'').split('-').map(Number);
    let H=9, M=0;
    if (hhmm && /^\d{2}:\d{2}$/.test(hhmm)) { [H,M] = hhmm.split(':').map(Number); }
    return new Date(y, (m||1)-1, d||1, H, M, 0, 0);
  }
  function notifyEligibleTodayImportant(now=new Date()){
    const f = fmtToday();
    const list = state.tasks.filter(t => t.important === true && t.status !== 'done' && t.date === f);
    return list.filter(t => {
      const at = t.notifyAt ? new Date(t.notifyAt) : combineYmdTimeLocal(t.date, t.notifyTime || '09:00');
      return now >= at;
    });
  }
  function initNotificationsUI(){
    const btn = $('#enableNotifs'), test = $('#testNotif'); if(!btn || !test) return;
    function refreshUI(){
      if(!notifSupported()){ btn.disabled = true; test.disabled = true; setNotifStatus('Not supported'); return; }
      if(!isSecure()){ btn.disabled = true; test.disabled = false; setNotifStatus('HTTPS/localhost required'); return; }
      btn.disabled = false; test.disabled = false;
      const perm = Notification.permission;
      if(perm==='granted'){ btn.textContent = 'üîî Enabled'; setNotifStatus('Enabled'); }
      else if(perm==='denied'){ btn.textContent = 'üîî Enable'; setNotifStatus('Blocked'); }
      else { btn.textContent = 'üîî Enable'; setNotifStatus('Not enabled'); }
    }
    refreshUI();
    if (navigator.permissions && navigator.permissions.query){
      try{ navigator.permissions.query({name:'notifications'}).then(p=>{ p.onchange = refreshUI; }).catch(()=>{}); }catch(_){}
    }
    btn.addEventListener('click', async ()=>{
      if(!isSecure()){ alert('Use HTTPS or http://localhost for notifications.'); return; }
      try{
        const res = await Notification.requestPermission();
        setTimeout(refreshUI, 50);
        if(res==='granted'){
          notifyTask({ id:'enabled-'+Date.now(), title:'‚úÖ Notifications enabled', clientName:'', date:fmtToday(), requireInteraction:true });
        } else if(res==='denied'){
          alert('Notifications are blocked. Allow them in your browser‚Äôs site settings.');
        }
      }catch(_){}
    });
    test.addEventListener('click', async ()=>{
      if(!isSecure()){ alert('Run from HTTPS or http://localhost.'); return; }
      if(Notification.permission==='default'){ try{ await Notification.requestPermission(); }catch(_){} }
      if(Notification.permission==='granted'){
        notifyTask({ id:'test-'+Date.now(), title:'üîî Test notification', clientName:'', date:fmtToday(), requireInteraction:true });
      }else if(Notification.permission==='denied'){
        alert('Notifications are blocked. Click the lock icon ‚Üí Site settings ‚Üí Allow.');
      }
    });
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshUI(); });
  }
  function startNotificationTicker(){
    let notified = getNotifiedSet();
    function tick(){
      if (!notifSupported() || Notification.permission!=='granted') return;
      const due = notifyEligibleTodayImportant();
      due.forEach(t => {
        if (!notified.has(t.id)){ notifyTask(t); notified.add(t.id); }
      });
      saveNotifiedSet(notified);
    }
    tick(); setInterval(tick, 60*1000); window.addEventListener('focus', tick);
  }

  /* ========= Calendar ========= */
  let calCursor = new Date(); calCursor.setDate(1);
  function buildCalendar(){
    const grid = $('#calendarGrid'); if(!grid) return;
    const year=calCursor.getFullYear(), month=calCursor.getMonth();
    const MONTH_ABBR = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    $('#calTitle').textContent = `${MONTH_ABBR[month]} ${year}`;
    grid.innerHTML = '';
    ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(h=>{ const hd=document.createElement('div'); hd.className='cal-head'; hd.textContent=h; grid.appendChild(hd); });
    const first = new Date(year, month, 1);
    const startIdx = (first.getDay()+6)%7; const daysInMonth = new Date(year, month+1, 0).getDate();
    for(let i=0;i<startIdx;i++){ grid.appendChild(document.createElement('div')); }
    for(let d=1; d<=daysInMonth; d++){
      const dt  = new Date(year, month, d);
      const ymd = fmt(dt);
      const items = state.tasks.filter(t => t.date === ymd && t.status !== 'done' && (!agendaFilter || (t.clientName||'').toLowerCase().includes(agendaFilter)));
      const cell = document.createElement('div');
      cell.className='cal-cell'; if(!isWorkingDay(dt)) cell.classList.add('offday');
      cell.innerHTML = `<div class="d">${d}</div>` + (items.length ? `<div class="cal-badge">${items.length}</div>` : '');
      cell.addEventListener('click', ()=>{
        $('#agendaDate').value = ymd;
        $('#agendaDate').dispatchEvent(new Event('change'));
        flashAgendaDate();
        const target = document.getElementById('actionsCard');
        if (target && target.scrollIntoView){
          target.scrollIntoView({ behavior:'smooth', block:'start' });
        } else {
          window.scrollTo({ top: $('#actionsCard').offsetTop - 70, behavior:'smooth' });
        }
      });
      grid.appendChild(cell);
    }
  }
  $('#calPrev')?.addEventListener('click', ()=>{ calCursor.setMonth(calCursor.getMonth()-1); buildCalendar(); });
  $('#calNext')?.addEventListener('click', ()=>{ calCursor.setMonth(calCursor.getMonth()+1); buildCalendar(); });
  function renderOverrideList(){
    const ul = $('#overrideList'); ul.innerHTML='';
    const entries = Object.entries(state.settings.overrides).sort((a,b)=> a[0].localeCompare(b[0]));
    if (!entries.length){ const li=document.createElement('li'); li.textContent='No overrides yet.'; ul.appendChild(li); return; }
    entries.forEach(([date,type])=>{
      const li = document.createElement('li');
      const left = document.createElement('span');
      left.textContent = `${date} ‚Äî ${type==='work'?'Working':'Off'}`;
      const del = document.createElement('button');
      del.textContent='Delete';
      del.addEventListener('click', ()=>{
        delete state.settings.overrides[date];
        regenerateAutoOpenTasksFromAnchors();
        renderOverrideList();
      });
      li.appendChild(left); li.appendChild(del); ul.appendChild(li);
    });
  }
  function loadSettingsIntoUI(){
    const s = state.settings;
    $('#wd_mon').checked = !!s.workingDays.mon;
    $('#wd_tue').checked = !!s.workingDays.tue;
    $('#wd_wed').checked = !!s.workingDays.wed;
    $('#wd_thu').checked = !!s.workingDays.thu;
    $('#wd_fri').checked = !!s.workingDays.fri;
    $('#wd_sat').checked = !!s.workingDays.sat;
    $('#wd_sun').checked = !!s.workingDays.sun;
    $('#moveOffDays').checked = !!s.moveOffDays;
    renderOverrideList();
  }
  function saveSettingsFromUI(){
    const s = state.settings;
    s.workingDays = {
      mon: !!$('#wd_mon').checked, tue: !!$('#wd_tue').checked, wed: !!$('#wd_wed').checked,
      thu: !!$('#wd_thu').checked, fri: !!$('#wd_fri').checked, sat: !!$('#wd_sat').checked, sun: !!$('#wd_sun').checked
    };
    s.moveOffDays = !!$('#moveOffDays').checked;
    if (!hasAnyWorkingDay()){
      alert('Select at least one working day. Defaulting to Monday.');
      s.workingDays.mon = true;
    }
    regenerateAutoOpenTasksFromAnchors();
    $('#calSettings').style.display = 'none';
  }
  $('#calSettingsBtn').addEventListener('click', ()=>{
    const el=$('#calSettings'); const open=el.style.display!=='none';
    el.style.display = open ? 'none' : 'block';
    if(!open) loadSettingsIntoUI();
  });
  $('#saveCalSettings').addEventListener('click', saveSettingsFromUI);
  $('#addOverride').addEventListener('click', ()=>{
    const d=$('#ovrDate').value; const t=$('#ovrType').value;
    if(!d) return alert('Pick a date');
    state.settings.overrides[d] = (t==='work' ? 'work' : 'off');
    regenerateAutoOpenTasksFromAnchors(); renderOverrideList();
  });

  /* ========= Parse + Form wiring ========= */
  function applyParsedToForm(parsed, { onlyFillEmpty = false } = {}){
    if(!parsed) return;
    const set = (id, val) => {
      if(!val) return;
      const el = document.querySelector(id);
      if(!el) return;
      if(onlyFillEmpty && (el.value || '').trim()) return;
      el.value = val;
    };
    set('#name',  parsed.name);
    set('#email', parsed.email);
    set('#phone', parsed.phone);
    set('#route', parsed.route);
    set('#dates', parsed.dates);
    set('#pax',   parsed.pax);
    set('#leadId', parsed.leadId);
    if(parsed.notes){
      const cur = ($('#notes').value || '').trim();
      $('#notes').value = cur ? (cur + '\n' + parsed.notes) : parsed.notes;
    }
  }
  function parseBlob({ onlyFillEmpty } = { onlyFillEmpty:false }){
    const blob = ($('#leadBlob').value || '').trim();
    if(!blob) return null;
    const parsed = parseLeadBlob(blob);
    applyParsedToForm(parsed, { onlyFillEmpty });
    return parsed;
  }
  function collectClientFromForm(){
    const id = $('#clientId').value || uid();
    const exists = state.clients.find(c=>c.id===id);
    const status = $('#status').value;
    const startDate = $('#startDate').value || fmt(today());
    const client = {
      id,
      name: ($('#name').value||'').trim(),
      email: ($('#email').value||'').trim(),
      phone: ($('#phone').value||'').trim(),
      status,
      startDate,
      reachedStart: exists ? exists.reachedStart : (status === 'reached' ? startDate : null),
      route: ($('#route').value||'').trim(),
      dates: ($('#dates').value||'').trim(),
      pax:   ($('#pax').value||'').trim(),
      leadId: ($('#leadId').value||'').trim(),
      notes: ($('#notes').value||'').trim()
    };
    return { client, exists };
  }
  // removed "Paste & Edit" button ‚Äì auto-parses on paste
  $('#clearLead')?.addEventListener('click', ()=> { $('#leadBlob').value=''; });

  $('#advToggle')?.addEventListener('click', ()=>{
    const box = $('#advFields');
    const isHidden = getComputedStyle(box).display==='none';
    box.style.display = isHidden ? 'block' : 'none';
    $('#advToggle').textContent = isHidden ? '‚ñæ Hide fields' : '‚ñ∏ More fields';
  });

  $('#resetForm').addEventListener('click', ()=>{ $('#clientForm').reset(); $('#clientId').value=''; });

  $('#saveCustomer').addEventListener('click', ()=>{
    try{
      if (($('#leadBlob').value || '').trim()){ parseBlob({ onlyFillEmpty:true }); }
      const {client, exists} = collectClientFromForm();
      if(!client.name){ alert('Name is required'); $('#name').focus(); return; }
      if(!exists){
        state.clients.push(client);
        if(client.status==='unreached') scheduleUnreached(client);
        else { client.reachedStart = client.startDate; scheduleReached(client); }
        toast('Customer added');
      } else {
        const i = state.clients.findIndex(x=>x.id===client.id);
        const prev = state.clients[i];
        state.clients[i] = client;
        const statusChanged = prev.status!==client.status;
        const anchorChanged = prev.startDate!==client.startDate || prev.reachedStart!==client.reachedStart;
        if(statusChanged){
          clearFutureTasksForClientFrom(client.id, today());
          if(client.status==='reached'){ client.reachedStart = fmt(today()); scheduleReached(client); }
          else { client.startDate = fmt(today()); scheduleUnreached(client); }
        } else if(anchorChanged){
          clearFutureTasksForClientFrom(client.id, today());
          if(client.status==='unreached') scheduleUnreached(client); else scheduleReached(client);
        }
        toast('Customer updated');
      }
      $('#leadBlob').value = '';
      $('#clientForm').reset();
      $('#clientId').value = '';
      save();
      closeAddModal();
    }catch(e){
      console.error(e);
      alert('Could not save customer. If this persists, click ‚ÄúWipe All‚Äù to clear local data and try again.');
      toast('Save failed', 'err', 2200);
    }
  });

  /* ===== Add Custom Task popover ===== */
  function titleDefaultFor(type){ return ({call:'Call', callvm:'Call + Voicemail', sms:'SMS', email:'Email'}[type] || ''); }
  function buildClientOptionsForPopover(){
    const sel = $('#ctClient'); if(!sel) return;
    const keep = sel.value;
    sel.innerHTML = '';
    const opts = [...state.clients].sort((a,b)=>a.name.localeCompare(b.name));
    sel.insertAdjacentHTML('beforeend', `<option value="" disabled selected hidden>Select client‚Ä¶</option>`);
    opts.forEach(c=>{
      const label = c.email ? `${c.name} ‚Äî ${c.email}` : (c.phone ? `${c.name} ‚Äî ${c.phone}` : c.name);
      sel.insertAdjacentHTML('beforeend', `<option value="${c.id}">${escapeHtml(label)}</option>`);
    });
    if (opts.length && keep) sel.value = keep;
  }
  function openCustomTaskPopover(){
    buildClientOptionsForPopover();
    const pop = document.getElementById('customTaskPop'); if(!pop) return;
    const isHidden = getComputedStyle(pop).display === 'none';
    if (isHidden){
      $('#ctType').value = $('#ctType').value || 'call';
      const agendaYmd = fmt(currentAgendaDate || today());
      if (!$('#ctDate').value) $('#ctDate').value = agendaYmd;
      if (!$('#ctTitle').value) $('#ctTitle').value = titleDefaultFor($('#ctType').value);
      $('#ctNotify').disabled = !$('#ctTime').value;
      pop.style.display = 'block';
    } else {
      pop.style.display = 'none';
    }
  }
  function clearCustomTaskForm(){
    ['ctClient','ctType','ctTitle','ctDate','ctTime','ctNotes'].forEach(id=>{
      const el = $('#'+id); if(!el) return;
      if (id==='ctType') el.value='call'; else el.value='';
    });
    $('#ctImportant').checked = false;
    $('#ctNotify').checked = false; $('#ctNotify').disabled = true;
  }
  function closeCustomTaskPopover(){
    clearCustomTaskForm();
    const pop = document.getElementById('customTaskPop');
    if (pop) pop.style.display = 'none';
  }
  function saveCustomTaskFromPopover(){
    const clientId = $('#ctClient').value;
    if(!clientId) return alert('Pick a client');
    const c = clientById(clientId); if(!c) return alert('Unknown client');
    const type  = $('#ctType').value || 'custom';
    let title   = ($('#ctTitle').value||'').trim();
    if (!title) title = titleDefaultFor(type) || 'Custom';
    const date  = $('#ctDate').value || fmt(currentAgendaDate || today());
    const time  = $('#ctTime').value || '';
    const notes = ($('#ctNotes').value||'').trim();
    const notify = !!$('#ctNotify').checked && !!time;
    const important = notify ? true : !!$('#ctImportant').checked;

    const t = { clientId: c.id, clientName: c.name, date, type, title, label: 'Custom', source: 'custom', status: 'open', notes, important };
    if (time){
      t.notifyTime = time;
      if (notify) t.notifyAt = combineYmdTimeLocal(date, time).toISOString();
    }

    addTask(t);
    save();
    toast('Custom task added');
    closeCustomTaskPopover();
  }
  // Popover markup exists later in the file (Agenda card)
  document.addEventListener('click', (e)=>{
    if(e.target?.id==='addTaskBtn') openCustomTaskPopover();
  });

  /* ========= Wipe All ========= */
  $('#wipeAll').addEventListener('click', () => {
    if (!confirm('Delete ALL customers, tasks, and calendar overrides? This cannot be undone.')) return;
    const tPref = localStorage.getItem(THEME_KEY);
    localStorage.removeItem(storeKey);
    state.clients=[]; state.tasks=[]; state.settings=defaults().settings;
    if(tPref) localStorage.setItem(THEME_KEY, tPref);
    save(); alert('All data cleared.');
  });

  /* ========= Notifications boot ========= */
  initNotificationsUI();
  startNotificationTicker();

  /* ========= Bootstrap ========= */
  function bootstrap(){ initAddModal(); refresh(); buildCalendar(); }
  bootstrap();

  /* === Wire up customers search/filter to re-render === */
  $('#search').addEventListener('input', refresh);
  $('#statusFilter').addEventListener('change', refresh);

})();
</script>
</body>
</html>
