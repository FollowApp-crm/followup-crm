<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Follow-Up CRM ‚Äî Standalone</title>

  <!-- ‚úÖ Checkmark favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%237c5cff'/%3E%3Cpath d='M18 34l8 8 20-20' stroke='%23fff' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E" />

  <!-- External CSS -->
  <link rel="stylesheet" href="app.css" />

  <!-- External JS -->
  <script src="./app.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex; align-items:center; gap:12px">
      <div>
        <h1>Follow-Up CRM</h1>
        <div class="sub">Local-only CRM (HTML + CSS + JS) for <b>Unreached</b> and <b>Reached</b> customers, agenda & calendar‚Äîno servers or logins.</div>
      </div>
      <div class="space"></div>
      <button id="themeToggle" class="toggle" aria-label="Toggle theme">‚òÄÔ∏è Light</button>
      <button id="moreBtn" class="toggle" aria-label="More settings">‚ò∞ More</button>
    </div>
  </header>

  <main class="wrap grid">

    <!-- Add/Edit card (moved into modal at runtime) -->
    <section class="card" id="addCard">
      <div class="hd">
        <strong>Add / Edit Customer</strong>
        <span class="badge">Local only</span>
        <div class="space"></div>
        <button id="closeAdd" class="btn-icon" title="Close">‚úñ</button>
      </div>
      <div class="bd">
        <div class="lead-block highlight">
          <div>
            <label>Paste from Leads CRM (auto-fills Name, Email, Phone, Route, Dates, Pax, Lead ID)</label>
            <textarea id="leadBlob" rows="6" placeholder="Paste the whole blob here‚Ä¶"></textarea>
          </div>
        </div>

        <form id="clientForm" novalidate>
          <input type="hidden" id="clientId" />
          <div class="row">
            <div>
              <label>Name</label>
              <input id="name" required placeholder="John Appleseed" />
            </div>
            <div>
              <label>Email</label>
              <input id="email" type="email" placeholder="john@company.com" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Phone</label>
              <input id="phone" placeholder="+1 555 123 4567" />
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="unreached">Unreached</option>
                <option value="reached">Reached</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Route</label>
              <input id="route" placeholder="JFK-LHR-AMS" />
            </div>
            <div>
              <label>Pax</label>
              <input id="pax" inputmode="numeric" pattern="\d*" placeholder="2" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Lead ID</label>
              <input id="leadId" inputmode="numeric" pattern="\d*" placeholder="55471" />
            </div>
            <div>
              <label>Dates</label>
              <input id="dates" placeholder="Sep 07 - Sep 15 or 2025-09-02 ‚Üí 2025-09-10" />
            </div>
          </div>

          <div class="row single">
            <div>
              <label>Notes</label>
              <textarea id="notes" rows="5" placeholder="Preferences, budget, route, remarks‚Ä¶"></textarea>
            </div>
          </div>

          <!-- Start date is now separate from actions -->
          <div class="row single">
            <div>
              <label>Start date (defaults to today)</label>
              <input id="startDate" type="date" />
            </div>
          </div>

          <!-- Sticky footer actions -->
          <div class="form-footer">
            <button type="button" class="ghost" id="resetForm">Clear</button>
            <button class="primary" type="button" id="saveCustomer">Save Customer</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Customers -->
    <section class="card">
      <div class="hd" style="gap:8px">
        <strong>Customers</strong>
        <button id="openAdd" class="btn-icon add-btn" title="Add customer" aria-label="Add customer">Ôºã</button>
        <div class="space"></div>
        <input id="search" placeholder="Search name, email, phone‚Ä¶" />
        <select id="statusFilter" title="Filter by status" style="max-width:160px">
          <option value="">All</option>
          <option value="unreached">Unreached</option>
          <option value="reached">Reached</option>
        </select>
      </div>
      <div class="bd">
        <div class="kpi">
          <div class="box"><div class="tiny">Total</div><div id="kTotal" class="num">0</div></div>
          <div class="box"><div class="tiny">Unreached</div><div id="kUn" class="num">0</div></div>
          <div class="box"><div class="tiny">Reached</div><div id="kRe" class="num">0</div></div>
          <div class="box"><div class="tiny">Open tasks</div><div id="kTasks" class="num">0</div></div>
        </div>

        <div class="mt16 customers-scroll" style="margin-top:12px; max-height:50vh; overflow-y:auto; overflow-x:hidden;">
          <table class="tbl" id="clientsTbl">
<thead>
  <tr>
    <th>Name</th>
    <th>Contact</th>
    <th>Status</th>
    <th>Date Taken</th>
    <th>Next Action</th>
    <th></th>
  </tr>
</thead>

            <tbody></tbody>
          </table>
        </div>

        <div class="mt16 right">
          <button class="btn-danger" id="wipeAll" title="Delete all data">Wipe All</button>
        </div>

        <div class="mt16 tiny">Rules:
          <ul>
            <li>Unreached: 5 working days. Day 1 has 2 emails (‚ÄúIntro & Info‚Äù and ‚Äú3PQ + Feedback‚Äù). Each day: 2 Calls (2nd becomes ‚ÄúCall + Voicemail‚Äù), 1 SMS.</li>
            <li>Reached: Phase 1 (3 working days), then +3d, +5d, +7d, +7d, +7d (working days respected). Each day: 2 Calls, 1 SMS, 1 Email.</li>
            <li>Manual Next FU: clears future tasks & schedules one 2 Calls + 1 SMS + 1 Email day on the picked date.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- Agenda + Calendar -->
    <div class="row agenda-layout">
      <!-- Agenda -->
      <section class="card" id="actionsCard">
        <div class="hd"><strong>Agenda</strong></div>
        <div class="bd">
          <div class="toolbar" id="agendaToolbar">

            <!-- Show group -->
            <span class="pill tiny mono">Show:</span>
            <div class="seg" role="group" aria-label="Show tasks">
              <button type="button" id="showAll"  class="primary" aria-pressed="true">All</button>
              <button type="button" id="showOpen" aria-pressed="false">Incomplete</button>
              <button type="button" id="showDone" aria-pressed="false">Complete</button>
            </div>

            <!-- Sort group (JS will keep/normalize this via mountSortGroupLabel) -->
            <div id="sortWrap" class="toolbar">
              <span id="sortLabel" class="pill tiny mono">Sort:</span>
              <div id="sortGroup" class="seg" role="group" aria-label="Sort tasks">
                <button type="button" id="sortClient" class="primary" aria-pressed="true">By client</button>
                <button type="button" id="sortType" aria-pressed="false">By task</button>
              </div>
            </div>

            <div class="space"></div>

            <!-- Range controls -->
            <button type="button" id="viewToday" class="primary">Today</button>
            <button type="button" id="viewWeek">Next 7 days</button>
            <button type="button" id="openCal" class="toggle" aria-controls="calendarDrawer" aria-expanded="false">üìÖ Calendar</button>
            <input type="date" id="agendaDate" />
            <input type="text" id="agendaFilter" class="mono" placeholder="Filter by client‚Ä¶" style="max-width:220px" />
            <button type="button" id="agendaFilterClear" title="Clear filter">‚úñ</button>

            <!-- Fancy + modal trigger -->
            <button type="button" id="addTaskBtn" class="btn-icon add-btn" title="Add task">Ôºã</button>

            <div class="space"></div>
            <button type="button" id="sendDueEmails" class="tiny" title="Open mail drafts for today‚Äôs unreached emails">Batch email (Unreached today)</button>

            <div class="space"></div>
            <span class="badge">Today's progress <span class="space"></span><span id="progressPct" class="mono">0%</span></span>
          </div>

          <!-- Notifications row -->
          <div class="slab" style="margin-top:10px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
            <span class="tiny mono">Notifications:</span>
            <button type="button" id="enableNotifs" class="tiny" title="Enable desktop notifications">üîî Enable</button>
            <button type="button" id="testNotif" class="tiny" title="Send a test notification">Test</button>
            <span id="notifStatus" class="pill">Status: Not enabled</span>
          </div>

          <!-- Add Custom Task modal (sheet inside overlay) -->
          <div id="customTaskPop" class="popover" style="display:none">
            <div class="sheet">
              <div class="pop-head" style="display:flex; align-items:center; gap:8px;">
                <strong>New task</strong>
                <div class="space"></div>
                <button type="button" class="btn-icon" id="ctClose" title="Close">‚úñ</button>
              </div>

              <div class="row">
                <div>
                  <label>Client</label>
                  <select id="ctClient"></select>
                </div>
                <div>
                  <label>Type</label>
                  <select id="ctType">
                    <option value="call">call</option>
                    <option value="callvm">callvm</option>
                    <option value="sms">sms</option>
                    <option value="email">email</option>
                    <option value="custom">custom</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Title</label>
                  <input id="ctTitle" placeholder="Call / Email / Custom‚Ä¶" />
                </div>
                <div>
                  <label>Date</label>
                  <input id="ctDate" type="date" />
                </div>
              </div>

              <div class="row">
                <div>
                  <label>Time (optional)</label>
                  <input id="ctTime" type="time" />
                </div>
                <div style="display:flex; align-items:center; gap:10px; padding-top:26px">
                  <label style="display:inline-flex;align-items:center;gap:6px"><input type="checkbox" id="ctImportant"> Important</label>
                  <label style="display:inline-flex;align-items:center;gap:6px" title="Enable desktop alert at the chosen time"><input type="checkbox" id="ctNotify" disabled> Notify me</label>
                </div>
              </div>

              <div class="row single">
                <div>
                  <label>Notes (optional)</label>
                  <textarea id="ctNotes" rows="3" placeholder="Context for this task‚Ä¶"></textarea>
                </div>
              </div>

              <div class="right" style="margin-top:8px">
                <button type="button" id="ctCancel" class="ghost">Cancel</button>
                <button type="button" id="ctSave" class="primary">Save task</button>
              </div>
            </div>
          </div>

          <div class="mt12 progress"><span id="progressBar"></span></div>
          <div id="agenda" class="mt12"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Slide-out Calendar Drawer -->
  <div id="calendarDrawer">
    <div class="drawer-scrim"></div>
    <aside class="drawer-panel">
      <!-- Calendar card MOVED here -->
      <section class="card" id="calendarCard">
        <div class="hd cal-hd">
          <strong>Calendar</strong>
          <div class="cal-month tiny">
            <button class="btn-icon" id="calPrev" title="Previous month">‚óÄ</button>
            <span id="calTitle" class="mono"></span>
            <button class="btn-icon" id="calNext" title="Next month">‚ñ∂</button>
          </div>
          <div class="space"></div>
          <button class="settings-btn" id="calSettingsBtn" title="Calendar settings">‚öôÔ∏è Settings</button>
          <button class="btn-icon" id="calDrawerClose" title="Close calendar">‚úñ</button>
        </div>

        <div class="bd">
          <!-- SETTINGS FIRST: shows above the calendar grid -->
<section id="calSettings" class="slab" style="margin-bottom:10px">
            <h4>Working days</h4>
            <div class="wdays">
              <div class="cell"><input type="checkbox" id="wd_mon"><span>Mon</span></div>
              <div class="cell"><input type="checkbox" id="wd_tue"><span>Tue</span></div>
              <div class="cell"><input type="checkbox" id="wd_wed"><span>Wed</span></div>
              <div class="cell"><input type="checkbox" id="wd_thu"><span>Thu</span></div>
              <div class="cell"><input type="checkbox" id="wd_fri"><span>Fri</span></div>
              <div class="cell"><input type="checkbox" id="wd_sat"><span>Sat</span></div>
              <div class="cell"><input type="checkbox" id="wd_sun"><span>Sun</span></div>
            </div>

            <div style="margin-top:10px">
              <label style="display:inline-flex;align-items:center;gap:8px">
                <input type="checkbox" id="moveOffDays"> Move tasks off non-working days
              </label>
            </div>

            <hr>

            <!-- Date-specific overrides row -->
            <div class="ovr">
              <div>
                <label for="ovrDate">Override date</label>
                <input type="date" id="ovrDate">
              </div>
              <div>
                <label for="ovrType">Type</label>
                <select id="ovrType">
                  <option value="off">Off</option>
                  <option value="work">Work</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button id="addOverride">Add override</button>
              </div>
            </div>

            <ul id="overrideList" class="ovr-list tiny" style="margin-top:10px"></ul>

            <div class="right" style="margin-top:10px">
              <button id="saveCalSettings" class="primary">Save</button>
            </div>
          </section>

          <!-- CALENDAR GRID AFTER (gets pushed down when settings open) -->
          <div id="calendarGrid"></div>
        </div>
      </section>
    </aside>
  </div>

  <!-- Toast container -->
  <div id="toaster" aria-live="polite"></div>
</body>
</html>
