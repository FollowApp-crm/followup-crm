<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Follow-Up CRM — Lite</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%237c5cff'/%3E%3Ctext x='50' y='61' font-size='54' text-anchor='middle' fill='white' font-family='Arial,Helvetica,sans-serif'%3E✓%3C/text%3E%3C/svg%3E" />
<style>
  :root{
    --bg:#0f1117; --panel:#151a21; --ink:#e8ecf3; --muted:#97a0ad; --line:#232a33;
    --chip:#1b2230; --brand:#7c5cff; --brand-2:#28c076; --danger:#e45858;
    --radius:14px; --maxw:980px;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink)}
  .wrap{max-width:min(92vw,var(--maxw)); margin:0 auto; padding:16px}
  header{position:sticky; top:0; z-index:2; background:rgba(15,17,23,.8); backdrop-filter:blur(6px); border-bottom:1px solid var(--line)}
  h1{margin:6px 0 2px; font-size:20px}
  .sub{color:var(--muted); font-size:12px}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .row.single{grid-template-columns:1fr}
  label{font-size:12px; color:var(--muted); display:block; margin:6px 0}
  input,select,textarea,button{width:100%; background:#10151d; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px}
  textarea{min-height:88px; resize:vertical}
  button{cursor:pointer}
  .btn{background:#171e27}
  .btn.primary{background:linear-gradient(180deg,var(--brand),#634cff); color:#fff; border-color:#5a46ff}
  .btn.warning{background:#25181a; border-color:#3b2124; color:#ffb3b3}
  .btn-icon{width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; padding:0}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:var(--chip); color:#cfd7e6; font-size:12px}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:0 8px 26px rgba(0,0,0,.25); margin:16px 0}
  .card .hd{padding:14px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:10px}
  .card .bd{padding:16px}
  .space{flex:1}

  /* Customers table → turns into cards on phones */
  table{width:100%; border-collapse:separate; border-spacing:0}
  th,td{padding:10px; border-bottom:1px solid var(--line); text-align:left; vertical-align:middle}
  th{color:#a7b0bd; font-size:12px}
  .actions{display:flex; gap:6px; justify-content:flex-end}
  .note-preview{color:#b7c0cf; cursor:pointer; font-family:ui-monospace,Consolas,monospace; font-size:12px}
  .note-preview:hover{text-decoration:underline}

  @media (max-width:680px){
    .row{grid-template-columns:1fr}
    table thead{display:none}
    table tr{display:block; border:1px solid var(--line); border-radius:12px; margin:10px 0; background:#10151d}
    table td{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--line)}
    table td:last-child{border-bottom:0}
    table td::before{content:attr(data-label); color:var(--muted); font-size:12px; margin-right:10px}
    .actions{justify-content:flex-start}
  }

  /* Agenda */
  .agenda-item{display:grid; grid-template-columns:24px 1fr auto; gap:10px; align-items:center; padding:10px; border:1px solid var(--line); border-radius:12px; background:#10151d}
  .agenda-item + .agenda-item{margin-top:8px}
  .tiny{font-size:12px; color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace; font-size:12px}
  .progress{height:10px; border-radius:999px; background:#0e131a; border:1px solid var(--line); overflow:hidden}
  .progress > span{display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)); width:0}

  .toggle{padding:8px 12px; border-radius:999px}
  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
  .kpi{background:#10151d; border:1px solid var(--line); border-radius:12px; padding:10px}
  .kpi strong{font-size:18px}
  @media (max-width:680px){ .kpis{grid-template-columns:repeat(2,1fr)} }

  /* Light */
  body.light{ --bg:#f7f8fb; --panel:#ffffff; --ink:#0c0f12; --muted:#5c6676; --line:#dbe2ee; --chip:#eef2fb }
  body.light .btn{background:#fff}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex; align-items:center; gap:12px">
    <div>
      <h1 style="margin:6px 0">Follow-Up CRM</h1>
      <div class="sub">Local, single-file tracker for Unreached / Reached flows.</div>
    </div>
    <div class="space"></div>
    <button id="themeToggle" class="toggle btn" aria-label="Toggle theme">☀️ Light</button>
  </div>
</header>

<main class="wrap">

  <!-- Add / Edit -->
  <section class="card">
    <div class="hd"><strong>Add / Edit Customer</strong><span class="pill">Local only</span></div>
    <div class="bd">
      <div class="row single">
        <div>
          <label>Paste from Leads CRM (optional)</label>
          <textarea id="leadBlob" placeholder="Paste raw lead text…"></textarea>
          <div class="toolbar" style="justify-content:flex-end; margin-top:8px">
            <button id="parseLead" class="btn">Parse & Fill</button>
            <button id="clearLead" class="btn">Clear</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Name</label>
          <input id="name" placeholder="John Appleseed" />
        </div>
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="john@company.com" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Phone</label>
          <input id="phone" placeholder="+1 (555) 123-4567" />
        </div>
        <div>
          <label>Status</label>
          <select id="status">
            <option value="unreached">Unreached</option>
            <option value="reached">Reached</option>
          </select>
        </div>
      </div>
      <div class="row single">
        <div>
          <label>Notes</label>
          <textarea id="notes" placeholder="Preferences, budget, route, remarks…"></textarea>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Start date (defaults to today)</label>
          <input id="startDate" type="date" />
        </div>
        <div style="align-self:end; display:flex; gap:8px; justify-content:flex-end">
          <button id="resetForm" class="btn">Clear Form</button>
          <button id="saveCustomer" class="btn primary">Save Customer</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Customers -->
  <section class="card">
    <div class="hd">
      <strong>Customers</strong>
      <div class="space"></div>
      <input id="search" placeholder="Search…" style="max-width:260px" />
      <select id="statusFilter" title="Filter" style="max-width:140px">
        <option value="">All</option>
        <option value="unreached">Unreached</option>
        <option value="reached">Reached</option>
      </select>
    </div>
    <div class="bd">
      <div class="kpis">
        <div class="kpi tiny">Total<br><strong id="kTotal">0</strong></div>
        <div class="kpi tiny">Unreached<br><strong id="kUn">0</strong></div>
        <div class="kpi tiny">Reached<br><strong id="kRe">0</strong></div>
        <div class="kpi tiny">Open tasks<br><strong id="kTasks">0</strong></div>
      </div>

      <div style="margin-top:12px; overflow-x:auto">
        <table class="tbl" id="clientsTbl">
          <thead>
            <tr>
              <th>Name</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Next Action</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div style="display:flex; justify-content:flex-end; margin-top:12px">
        <button id="wipeAll" class="btn warning">Wipe All</button>
      </div>
    </div>
  </section>

  <!-- Agenda -->
  <section class="card" id="actionsCard">
    <div class="hd"><strong>Today / Upcoming</strong></div>
    <div class="bd">
      <div class="toolbar">
        <button id="viewToday" class="btn primary">Today</button>
        <button id="viewWeek" class="btn">Next 7 days</button>
        <input type="date" id="agendaDate" />
        <input id="agendaFilter" class="mono" placeholder="Filter by client…" style="max-width:220px" />
        <button id="agendaFilterClear" class="btn" style="max-width:120px">Clear</button>

        <div class="space"></div>
        <div class="pill">Sort:</div>
        <div class="toolbar">
          <button id="sortType" class="btn primary" style="width:110px">By task</button>
          <button id="sortClient" class="btn" style="width:110px">By client</button>
        </div>
        <button id="sendDueEmails" class="btn" title="Open drafts for today’s Unreached emails">Send Due Emails</button>
      </div>

      <div class="progress" style="margin-top:10px"><span id="progressBar"></span></div>
      <div class="tiny" style="margin-top:6px">Today’s progress: <span id="progressPct" class="mono">0%</span></div>

      <div id="agenda" style="margin-top:12px"></div>
    </div>
  </section>

</main>

<script>
(function(){
  'use strict';

  /* ========== Tiny helpers ========== */
  const $  = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const storeKey = 'followup_crm_lite_v1';
  const THEME_KEY = 'followup_crm_theme';

  function uid(){ return 'id'+Math.random().toString(36).slice(2)+Date.now().toString(36); }
  function today(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function addDays(date, n){ const d = new Date(date); d.setDate(d.getDate()+n); return d; }
  function fmt(d){ if(!(d instanceof Date)) d=new Date(d); const z=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
  function parseLocalYMD(ymd){ if(!ymd) return today(); const [y,m,d]=ymd.split('-').map(Number); const dt=new Date(y,(m||1)-1,d||1); dt.setHours(0,0,0,0); return dt; }
  const first = s => (s||'').trim().split(' ')[0] || '';

  /* Weekdays (Mon–Fri) scheduling */
  function isWorkingDay(dt){ const g=dt.getDay(); return g>=1 && g<=5; }
  function nextWorkingDay(fromDate){ let d=new Date(fromDate); while(!isWorkingDay(d)) d=addDays(d,1); return d; }
  function stepByWorkingDays(fromDate, steps){ let d=new Date(fromDate); for(let i=0;i<steps;i++) d=nextWorkingDay(addDays(d,1)); return d; }
  function adjustToWorking(dt){ let d=new Date(dt); while(!isWorkingDay(d)) d=addDays(d,1); return d; }

  /* Theme */
  function applyTheme(t){ document.body.classList.toggle('light', t==='light'); $('#themeToggle').textContent = t==='light' ? '🌙 Dark' : '☀️ Light'; }
  applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
  $('#themeToggle').addEventListener('click', ()=>{
    const next = document.body.classList.contains('light') ? 'dark' : 'light';
    localStorage.setItem(THEME_KEY, next); applyTheme(next);
  });

  /* State */
  function load(){ try{ return JSON.parse(localStorage.getItem(storeKey) || '{"clients":[],"tasks":[]}'); }catch(e){ return {clients:[],tasks:[]}; } }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); refresh(); }
  const state = load();

  /* ======== SMS helper (updated behavior) ======== */
  const SMS_TEMPLATE = (name='') => `Hi ${first(name)}, quick follow-up — do you have 2 minutes to review?`;

  function cleanDigits(num){ return (num||'').replace(/[^\d+]/g,''); }
  function openRcWebComposePopup(number, body, { closeMs=2500, keepOpen=false } = {}){
    const num = cleanDigits(number);
    const url = `https://app.ringcentral.com/r/sms?type=new&number=${encodeURIComponent(num)}${body?`&content=${encodeURIComponent(body)}`:''}`;
    const w = window.open(url,'rcsms','width=900,height=720,left=120,top=80,toolbar=0,location=1,menubar=0,scrollbars=1,status=0,resizable=1');
    if(!w){ alert('Popup blocked. Allow popups for this site.'); return; }
    if(!keepOpen) setTimeout(()=>{ try{ w.close(); }catch(_){} }, closeMs);
  }

  document.addEventListener('click', async (e)=>{
    const el = e.target.closest('a.sms-link');
    if(!el) return;
    e.preventDefault();
    const num  = el.getAttribute('data-num')  || el.textContent || '';
    const name = el.getAttribute('data-name') || '';
    const text = SMS_TEMPLATE(name);

    try{
      if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); }
      else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
    }catch(_){}

    if(e.altKey){
      // Mobile app route (no guaranteed prefill, but text is already copied)
      window.location.href = `rcmobile://sms?number=${encodeURIComponent(cleanDigits(num))}`;
      return;
    }
    openRcWebComposePopup(num, text, { keepOpen: e.shiftKey, closeMs: 2500 });
  });

  /* ======== Links / templates ======== */
  const CALL_LINK_MODE = 'tel';
  function phoneHref(num){ const clean=(num||'').replace(/[^\d+]/g,''); return CALL_LINK_MODE==='callto'?`callto:${clean}`:`tel:${clean}`; }
  const EMAIL_MODE = 'gmail';
  function emailHref(addr, subject='', body=''){
    const enc = s => encodeURIComponent(s||'');
    if(EMAIL_MODE==='gmail') return `https://mail.google.com/mail/?view=cm&fs=1&to=${enc(addr)}&su=${enc(subject)}&body=${enc(body)}&tf=1`;
    return `mailto:${addr}?subject=${enc(subject)}&body=${enc(body)}`;
  }

  /* ======== Parser (quick, practical) ======== */
  function parseLeadBlob(text){
    const whole = (text||'').replace(/\r/g,' ').replace(/\s+/g,' ').trim();
    const email = (whole.match(/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i)||[''])[0];
    const phone = (whole.match(/\+?\d[\d\s().-]{6,}\d/)||[''])[0];
    // Try to grab the word(s) after "new"
    let name = ''; const m = whole.match(/\bnew\b\s+([^0-9\-:|/\\]+?)(?=\s+[A-Z]{2,3}\b|\s{2,}|$)/i); if(m) name = m[1].trim();
    return { name, email, phone, notes: '' };
  }

  /* ======== Scheduling rules ======== */
  const ACTIONS_UNREACHED = d => ({ calls:2, voicemail:1, sms:1, emails: d===1?2:1 });
  const ACTIONS_REACHED   = { calls:2, voicemail:1, sms:1, emails:1 };

  function addTask(t){
    t.id = t.id || uid();
    t.status = t.status || 'open';
    const dup = state.tasks.some(x => x.clientId===t.clientId && x.date===t.date && x.type===t.type && (x.title||'')===(t.title||''));
    if(!dup) state.tasks.push(t);
  }

  function genDayTasks(client, date, a, label){
    const base = {clientId:client.id, clientName:client.name, date, source:'auto', label};
    if(a.calls>=1) addTask({...base, type:'call',   title:'Call'});
    if(a.voicemail>=1) addTask({...base, type:'callvm', title:'Call + Voicemail'});
    else if(a.calls>=2) addTask({...base, type:'call', title:'Call 2'});
    for(let i=0;i<a.sms;i++) addTask({...base, type:'sms', title:'SMS'});
    if(label && label.startsWith('Unreached Day 1')){
      addTask({...base, type:'email', title:'Introduction & Info Emails'});
      addTask({...base, type:'email', title:'3PQ + Feedback Request Email'});
    }else{
      for(let i=0;i<a.emails;i++) addTask({...base, type:'email', title:'Email'});
    }
  }

  function scheduleUnreached(client){
    const start0 = client.startDate ? parseLocalYMD(client.startDate) : today();
    let day = nextWorkingDay(start0);
    for(let i=1;i<=5;i++){
      const ymd = fmt(day);
      genDayTasks(client, ymd, ACTIONS_UNREACHED(i), `Unreached Day ${i}`);
      if(i<5) day = stepByWorkingDays(day, 1);
    }
  }

  function scheduleReached(client){
    const start0 = client.reachedStart ? parseLocalYMD(client.reachedStart) : today();
    const p1d1 = nextWorkingDay(start0);
    const p1d2 = stepByWorkingDays(p1d1, 1);
    const p1d3 = stepByWorkingDays(p1d2, 1);
    genDayTasks(client, fmt(p1d1), ACTIONS_REACHED, 'Phase 1 (Day 1/3)');
    genDayTasks(client, fmt(p1d2), ACTIONS_REACHED, 'Phase 1 (Day 2/3)');
    genDayTasks(client, fmt(p1d3), ACTIONS_REACHED, 'Phase 1 (Day 3/3)');

    const gaps = [3,5,7,7,7];
    let last = p1d3;
    for(let i=0;i<gaps.length;i++){
      let target = addDays(last, gaps[i]);
      target = adjustToWorking(target);
      genDayTasks(client, fmt(target), ACTIONS_REACHED, `Phase ${i+2}`);
      last = target;
    }
  }

  function markDone(id, done){ const t = state.tasks.find(x=>x.id===id); if(!t) return; t.status = done?'done':'open'; save(); }
  function deleteTask(id){ state.tasks = state.tasks.filter(t=>t.id!==id); save(); }
  function clearFutureTasksForClientFrom(id, from){ const f=fmt(from); state.tasks = state.tasks.filter(t => !(t.clientId===id && t.date>=f)); }

  /* ======== UI: Customers ======== */
  function clientById(id){ return state.clients.find(c=>c.id===id); }
  function nextActionDateForClient(id){ const open=state.tasks.filter(t=>t.clientId===id && t.status==='open').sort((a,b)=>a.date.localeCompare(b.date)); return open[0]?.date || '—'; }

  function refresh(){
    $('#kTotal').textContent = state.clients.length;
    $('#kUn').textContent    = state.clients.filter(c=>c.status==='unreached').length;
    $('#kRe').textContent    = state.clients.filter(c=>c.status==='reached').length;
    $('#kTasks').textContent = state.tasks.filter(t=>t.status==='open').length;

    const body = $('#clientsTbl tbody'); body.innerHTML = '';
    const q = ($('#search').value||'').toLowerCase();
    const f = ($('#statusFilter').value||'').toLowerCase();

    [...state.clients]
      .sort((a,b)=>a.name.localeCompare(b.name))
      .filter(c => (!f || c.status===f))
      .filter(c => [c.name,c.email,c.phone,(c.notes||'')].join(' ').toLowerCase().includes(q))
      .forEach(c=>{
        const tr = document.createElement('tr'); tr.setAttribute('data-rowid', c.id);
        const contact = `
          ${c.email ? `<a href="${emailHref(c.email,'Follow-up','Hi …')}" target="_blank" rel="noopener">${escapeHtml(c.email)}</a>` : '-'}<br>
          ${c.phone ? `<a href="${phoneHref(c.phone)}">${escapeHtml(c.phone)}</a>` : '-'}`;
        tr.innerHTML = `
          <td data-label="Name">
            <strong>${escapeHtml(c.name)}</strong>
            ${c.notes?`<div class="note-preview tiny" data-act="note" data-id="${c.id}" title="Show notes">${escapeHtml(trunc(c.notes, 90))}</div>`:''}
          </td>
          <td data-label="Contact" class="tiny">${contact}</td>
          <td data-label="Status"><span class="pill">${c.status}</span></td>
          <td data-label="Next">${nextActionDateForClient(c.id)}</td>
          <td data-label="Actions">
            <div class="actions">
              <button class="btn-icon" data-act="edit"  data-id="${c.id}" title="Edit">🖊️</button>
              <button class="btn-icon" data-act="reach" data-id="${c.id}" title="${c.status==='unreached'?'Mark Reached':'Mark Unreached'}">${c.status==='unreached'?'✅':'↩️'}</button>
              <button class="btn-icon" data-act="del"   data-id="${c.id}" title="Delete">🗑️</button>
            </div>
          </td>`;
        body.appendChild(tr);
      });

    renderAgenda();
    updateProgress();
  }

  function trunc(s,n){ if(!s) return ''; return s.length>n ? s.slice(0,n-1)+'…' : s; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* Notes toggle (simple) */
  function toggleNotesRow(id){
    const existing = document.querySelector(`.note-row[data-for="${id}"]`);
    if(existing){ existing.remove(); return; }
    const tr = document.querySelector(`tr[data-rowid="${id}"]`); if(!tr) return;
    const c = clientById(id) || {};
    const row = document.createElement('tr'); row.className='note-row'; row.setAttribute('data-for', id);
    const td = document.createElement('td'); td.colSpan = 5;
    td.innerHTML = `<div style="background:#10151d;border:1px solid var(--line);border-radius:12px;padding:12px" class="tiny">${escapeHtml(c.notes||'No notes.')}</div>`;
    row.appendChild(td); tr.after(row);
  }

  $('#clientsTbl').addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act]'); if(!btn) return;
    const id  = btn.getAttribute('data-id');
    const act = btn.getAttribute('data-act');
    const c   = clientById(id);

    if(act==='note'){ toggleNotesRow(id); return; }
    if(act==='edit'){
      $('#clientId').value = c.id;
      $('#name').value     = c.name || '';
      $('#email').value    = c.email || '';
      $('#phone').value    = c.phone || '';
      $('#status').value   = c.status;
      $('#startDate').value= c.startDate || '';
      $('#notes').value    = c.notes || '';
      window.scrollTo({top:0, behavior:'smooth'});
      return;
    }
    if(act==='reach'){
      c.status = (c.status==='unreached') ? 'reached' : 'unreached';
      if(c.status==='reached'){
        c.reachedStart = fmt(today());
        clearFutureTasksForClientFrom(c.id, today());
        scheduleReached(c);
      }else{
        c.startDate = fmt(today());
        clearFutureTasksForClientFrom(c.id, today());
        scheduleUnreached(c);
      }
      save();
      return;
    }
    if(act==='del'){
      if(confirm('Delete this customer and all their tasks?')){
        state.clients = state.clients.filter(x=>x.id!==id);
        state.tasks   = state.tasks.filter(t=>t.clientId!==id);
        save();
      }
    }
  });

  /* ======== Forms ======== */
  $('#parseLead').addEventListener('click', ()=>{
    const raw = $('#leadBlob').value.trim(); if(!raw){ alert('Paste the lead text first.'); return; }
    const p = parseLeadBlob(raw);
    if(p.name)  $('#name').value = p.name;
    if(p.email) $('#email').value = p.email;
    if(p.phone) $('#phone').value = p.phone;
    if(p.notes){ const cur=$('#notes').value.trim(); $('#notes').value = cur ? (cur+'\n'+p.notes) : p.notes; }
  });
  $('#clearLead').addEventListener('click', ()=> $('#leadBlob').value='');

  function collectClientFromForm(){
    const id = $('#clientId').value || uid();
    const exists  = clientById(id);
    const status  = $('#status').value;
    const start   = $('#startDate').value || fmt(today());
    const client  = {
      id,
      name:  ($('#name').value||'').trim(),
      email: ($('#email').value||'').trim(),
      phone: ($('#phone').value||'').trim(),
      status,
      startDate: start,
      reachedStart: exists ? exists.reachedStart : (status==='reached' ? start : null),
      notes: ($('#notes').value||'').trim()
    };
    return { client, exists };
  }

  $('#saveCustomer').addEventListener('click', ()=>{
    const {client, exists} = collectClientFromForm();
    if(!client.name){ alert('Name is required.'); $('#name').focus(); return; }

    if(!exists){
      state.clients.push(client);
      if(client.status==='unreached') scheduleUnreached(client);
      else { client.reachedStart = client.startDate; scheduleReached(client); }
    }else{
      // update client record
      const i = state.clients.findIndex(x=>x.id===client.id);
      state.clients[i] = client;

      // if status or schedule anchor changed → rebuild future
      const statusChanged = exists.status !== client.status;
      const anchorChanged = exists.startDate !== client.startDate || exists.reachedStart !== client.reachedStart;

      if(statusChanged || anchorChanged){
        clearFutureTasksForClientFrom(client.id, today());
        (client.status==='unreached') ? scheduleUnreached(client) : scheduleReached(client);
      }
    }

    save();
    $('#clientForm')?.reset?.(); $('#clientId') && ($('#clientId').value='');
  });

  $('#resetForm').addEventListener('click', ()=>{ $('#clientForm')?.reset?.(); $('#clientId').value=''; });

  /* ======== Agenda ======== */
  let currentAgendaDate = today();
  let agendaFilter = '';
  let sortMode = 'type'; // 'type' | 'client'
  let renderAgenda = ()=> buildAgenda(currentAgendaDate);

  function typeOrder(t){ return ({call:1, callvm:2, voicemail:3, sms:4, email:5, custom:6}[t]||9); }
  function clientName(t){ return t.clientName || (t.clientId ? (clientById(t.clientId)||{}).name : '') || ''; }
  function matchesFilter(t){ return !agendaFilter || clientName(t).toLowerCase().includes(agendaFilter); }

  function renderTask(t){
    const div = document.createElement('div');
    div.className = 'agenda-item';
    const icon = { call:'📞', callvm:'📞🗣️', voicemail:'🗣️', sms:'💬', email:'✉️' }[t.type] || '•';
    const c = clientById(t.clientId)||{};
    let contact = '';
    if((t.type==='call'||t.type==='callvm') && c.phone){
      contact = `<span class="pill"><a class="mono" href="${phoneHref(c.phone)}">${escapeHtml(c.phone)}</a></span>`;
    }else if(t.type==='sms' && c.phone){
      contact = `<span class="pill">
        <a class="mono sms-link" href="#" data-num="${escapeHtml(c.phone)}" data-name="${escapeHtml(c.name||'')}">${escapeHtml(c.phone)}</a>
      </span>`;
    }else if(t.type==='email' && c.email){
      contact = `<span class="pill"><a class="mono" target="_blank" rel="noopener" href="${emailHref(c.email,'Follow-up','Hi …')}">${escapeHtml(c.email)}</a></span>`;
    }
    div.innerHTML = `
      <input type="checkbox" ${t.status==='done'?'checked':''} data-taskid="${t.id}"/>
      <div>
        <div><strong>${icon} ${escapeHtml(t.title)}</strong> ${c.name?`<span class="pill">${escapeHtml(c.name)}</span>`:''} ${contact}</div>
        <div class="tiny">${escapeHtml(t.label||'')}</div>
      </div>
      <div class="tiny mono">${t.date} <button class="btn-icon" data-del="${t.id}" title="Delete">🗑️</button></div>`;
    div.querySelector('input').addEventListener('change', ev => markDone(t.id, ev.target.checked));
    return div;
  }

  function sortTasks(a,b){
    const byType = typeOrder(a.type) - typeOrder(b.type);
    const byName = clientName(a).toLowerCase().localeCompare(clientName(b).toLowerCase());
    const byTitle = (a.title||'').localeCompare(b.title||'');
    return sortMode==='client' ? (byName||byType||byTitle) : (byType||byName||byTitle);
  }

  function buildAgenda(d){
    const f = fmt(d);
    const items = state.tasks.filter(t => t.date===f && matchesFilter(t)).sort(sortTasks);
    const cont = $('#agenda'); cont.innerHTML = '';
    if(items.length===0){ cont.innerHTML = `<div class="tiny">No tasks for ${f}.</div>`; updateProgress(); return; }
    items.forEach(t => cont.appendChild(renderTask(t)));
    updateProgress();
  }

  function buildAgendaRange(from, to){
    const cont = $('#agenda'); cont.innerHTML = '';
    const days = Math.ceil((to-from)/86400000)+1;
    for(let i=0;i<days;i++){
      const d = addDays(from,i), f = fmt(d);
      const block = state.tasks.filter(t => t.date===f && matchesFilter(t)).sort(sortTasks);
      const head = document.createElement('div'); head.className='tiny'; head.innerHTML = `<div class="pill mono">${f}</div>`;
      cont.appendChild(head);
      if(block.length===0){ const none=document.createElement('div'); none.className='tiny'; none.textContent='No tasks'; cont.appendChild(none); continue; }
      block.forEach(t => cont.appendChild(renderTask(t)));
    }
    updateProgress();
  }

  function updateProgress(){
    const f = fmt(today());
    const todays = state.tasks.filter(t=>t.date===f);
    const done = todays.filter(t=>t.status==='done').length;
    const total = todays.length || 1;
    const pct = Math.round((done/total)*100);
    $('#progressPct').textContent = pct+'%';
    $('#progressBar').style.width = pct+'%';
  }

  $('#agenda').addEventListener('click', e=>{
    const del = e.target.closest('[data-del]'); if(!del) return;
    const id = del.getAttribute('data-del');
    if(confirm('Delete this task?')) deleteTask(id);
  });

  // Agenda controls
  $('#viewToday').addEventListener('click', ()=>{
    currentAgendaDate = today(); renderAgenda = ()=>buildAgenda(currentAgendaDate);
    $('#viewToday').classList.add('primary'); $('#viewWeek').classList.remove('primary');
    $('#agendaDate').value=''; renderAgenda();
  });
  $('#viewWeek').addEventListener('click', ()=>{
    const from = today(); const to = addDays(today(),7);
    renderAgenda = ()=>buildAgendaRange(from, to);
    $('#viewWeek').classList.add('primary'); $('#viewToday').classList.remove('primary');
    $('#agendaDate').value=''; renderAgenda();
  });
  $('#agendaDate').addEventListener('change', ()=>{
    const d = $('#agendaDate').value ? parseLocalYMD($('#agendaDate').value) : today();
    currentAgendaDate = d; renderAgenda = ()=>buildAgenda(currentAgendaDate);
    $('#viewToday').classList.remove('primary'); $('#viewWeek').classList.remove('primary');
    renderAgenda();
  });
  $('#agendaFilter').addEventListener('input', ()=>{
    agendaFilter = $('#agendaFilter').value.trim().toLowerCase(); renderAgenda();
  });
  $('#agendaFilterClear').addEventListener('click', ()=>{
    $('#agendaFilter').value=''; agendaFilter=''; renderAgenda();
  });
  $('#sortType').addEventListener('click', ()=>{ sortMode='type'; $('#sortType').classList.add('primary'); $('#sortClient').classList.remove('primary'); renderAgenda(); });
  $('#sortClient').addEventListener('click', ()=>{ sortMode='client'; $('#sortClient').classList.add('primary'); $('#sortType').classList.remove('primary'); renderAgenda(); });

  /* ======== Batch Emails for Unreached today ======== */
  function emailTemplateFor(t, client){
    if((t.label||'').startsWith('Unreached Day 1')) return {subject:'Welcome — next steps', body:`Hi ${client?.name||''},\n\nGreat to connect. Here’s the info…\n\nBest,\n`};
    return {subject:'Quick follow-up', body:`Hi ${client?.name||''},\n\nJust checking in…\n\nBest,\n`};
  }
  function collectDueUnreachedEmails(){
    const f = fmt(today());
    return state.tasks.filter(t=>{
      if(t.date!==f || t.status==='done' || t.type!=='email') return false;
      const c = clientById(t.clientId); return c && c.status==='unreached' && c.email;
    });
  }
  function launchBatchMailtos(tasks){
    let i=0; (function openNext(){
      if(i>=tasks.length) return;
      const t = tasks[i++]; const c = clientById(t.clientId);
      const {subject, body} = emailTemplateFor(t, c||{});
      window.open(emailHref(c.email, subject, body), '_blank');
      setTimeout(openNext, 600);
    })();
  }
  $('#sendDueEmails').addEventListener('click', ()=>{
    const due = collectDueUnreachedEmails();
    if(!due.length){ alert('No Unreached emails due today.'); return; }
    if(confirm(`Open ${due.length} email compose window(s)?`)) launchBatchMailtos(due);
  });

  /* ======== Misc ======== */
  $('#search').addEventListener('input', refresh);
  $('#statusFilter').addEventListener('change', refresh);

  document.getElementById('wipeAll').addEventListener('click', ()=>{
    if(!confirm('Delete ALL customers and tasks?')) return;
    state.clients = []; state.tasks = [];
    save(); alert('All data cleared.');
  });

  // Simple note preview click in name cell
  $('#clientsTbl').addEventListener('click', (e)=>{
    const p = e.target.closest('.note-preview'); if(!p) return;
    toggleNotesRow(p.getAttribute('data-id'));
  });

  /* ======== Bootstrap ======== */
  function bootstrap(){ refresh(); buildAgenda(today()); }
  bootstrap();

})();
</script>
</body>
</html>